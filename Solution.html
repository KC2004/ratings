<!DOCTYPE html>
<!-- saved from url=(0092)http://fellowship.hackbrightacademy.com/materials/f17a/exercises/ratings/solution/index.html -->
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <title>Solution</title>

    <link rel="stylesheet" href="./Solution_files/pygments.css" type="text/css">
    <link rel="stylesheet" href="./Solution_files/handouts-sphinx.css">

    <link href="./Solution_files/css" rel="stylesheet" type="text/css">
</head>
<body>
<div id="page-wrapper">
    <div id="page-sidebar">
        <header>
            <p class="project">Hackbright Fellowship March 2017</p>

            <p class="title">Solution</p>

            <p class="backlink"><a href="http://fellowship.hackbrightacademy.com/"> Â« Back to Homepage</a></p>

        </header>
        <div id="toc">
            <ul>
<li><a class="reference internal" href="http://fellowship.hackbrightacademy.com/materials/f17a/exercises/ratings/solution/index.html#">Solution</a><ul>
<li><a class="reference internal" href="http://fellowship.hackbrightacademy.com/materials/f17a/exercises/ratings/solution/index.html#end-of-step-1">End of Step 1</a></li>
<li><a class="reference internal" href="http://fellowship.hackbrightacademy.com/materials/f17a/exercises/ratings/solution/index.html#end-of-step-2">End of Step 2</a><ul>
<li><a class="reference internal" href="http://fellowship.hackbrightacademy.com/materials/f17a/exercises/ratings/solution/index.html#templates">Templates</a></li>
</ul>
</li>
<li><a class="reference internal" href="http://fellowship.hackbrightacademy.com/materials/f17a/exercises/ratings/solution/index.html#end-of-step-3">End of Step 3</a><ul>
<li><a class="reference internal" href="http://fellowship.hackbrightacademy.com/materials/f17a/exercises/ratings/solution/index.html#id1">Templates</a></li>
</ul>
</li>
<li><a class="reference internal" href="http://fellowship.hackbrightacademy.com/materials/f17a/exercises/ratings/solution/index.html#bootstrap">Bootstrap</a><ul>
<li><a class="reference internal" href="http://fellowship.hackbrightacademy.com/materials/f17a/exercises/ratings/solution/index.html#id2">Templates</a></li>
</ul>
</li>
</ul>
</li>
</ul>

        </div>
    </div>
    <div id="page-content">
        
  <div class="section" id="solution">
<h1>Solution</h1>
<div class="section" id="end-of-step-1">
<h2>End of Step 1</h2>
<div class="literal-block-wrapper container" id="id3">
<div class="code-block-caption"><span class="caption-text">step-1/model.py</span></div>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="sd">"""Models and database functions for Ratings project."""</span>

<span class="kn">from</span> <span class="nn">flask_sqlalchemy</span> <span class="kn">import</span> <span class="n">SQLAlchemy</span>

<span class="c1"># This is the connection to the PostgreSQL database; we're getting</span>
<span class="c1"># this through the Flask-SQLAlchemy helper library. On this, we can</span>
<span class="c1"># find the `session` object, where we do most of our interactions</span>
<span class="c1"># (like committing, etc.)</span>

<span class="n">db</span> <span class="o">=</span> <span class="n">SQLAlchemy</span><span class="p">()</span>


<span class="c1">#####################################################################</span>
<span class="c1"># Model definitions</span>

<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="sd">"""User of ratings website."""</span>

    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">"users"</span>

    <span class="n">user_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span>
                        <span class="n">autoincrement</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                        <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">64</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">64</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">age</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">zipcode</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">15</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""Provide helpful representation when printed."""</span>

        <span class="k">return</span> <span class="s2">"&lt;User user_id=</span><span class="si">%s</span><span class="s2"> email=</span><span class="si">%s</span><span class="s2">&gt;"</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_id</span><span class="p">,</span>
                                               <span class="bp">self</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Movie</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="sd">"""Movie on ratings website."""</span>

    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">"movies"</span>

    <span class="n">movie_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span>
                         <span class="n">autoincrement</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                         <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">100</span><span class="p">))</span>
    <span class="n">released_at</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">DateTime</span><span class="p">)</span>
    <span class="n">imdb_url</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">200</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""Provide helpful representation when printed."""</span>

        <span class="k">return</span> <span class="s2">"&lt;Movie movie_id=</span><span class="si">%s</span><span class="s2"> title=</span><span class="si">%s</span><span class="s2">&gt;"</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">movie_id</span><span class="p">,</span>
                                                 <span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Rating</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="sd">"""Rating of a movie by a user."""</span>

    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">"ratings"</span>

    <span class="n">rating_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span>
                          <span class="n">autoincrement</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                          <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">movie_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">)</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">)</span>
    <span class="n">score</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""Provide helpful representation when printed."""</span>

        <span class="n">s</span> <span class="o">=</span> <span class="s2">"&lt;Rating rating_id=</span><span class="si">%s</span><span class="s2"> movie_id=</span><span class="si">%s</span><span class="s2"> user_id=</span><span class="si">%s</span><span class="s2"> score=</span><span class="si">%s</span><span class="s2">&gt;"</span>
        <span class="k">return</span> <span class="n">s</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rating_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">movie_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_id</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">score</span><span class="p">)</span>


<span class="c1">#####################################################################</span>
<span class="c1"># Helper functions</span>

<span class="k">def</span> <span class="nf">connect_to_db</span><span class="p">(</span><span class="n">app</span><span class="p">):</span>
    <span class="sd">"""Connect the database to our Flask app."""</span>

    <span class="c1"># Configure to use our PostgreSQL database</span>
    <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">'SQLALCHEMY_DATABASE_URI'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'postgresql:///ratings'</span>
    <span class="n">db</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="n">app</span>
    <span class="n">db</span><span class="o">.</span><span class="n">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="c1"># As a convenience, if we run this module interactively, it will</span>
    <span class="c1"># leave you in a state of being able to work with the database</span>
    <span class="c1"># directly.</span>

    <span class="kn">from</span> <span class="nn">server</span> <span class="kn">import</span> <span class="n">app</span>
    <span class="n">connect_to_db</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="k">print</span> <span class="s2">"Connected to DB."</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper container" id="id4">
<div class="code-block-caption"><span class="caption-text">seed.py</span></div>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="sd">"""Utility file to seed ratings database from MovieLens data in seed_data/"""</span>

<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">func</span>

<span class="kn">from</span> <span class="nn">model</span> <span class="kn">import</span> <span class="n">User</span><span class="p">,</span> <span class="n">Rating</span><span class="p">,</span> <span class="n">Movie</span><span class="p">,</span> <span class="n">connect_to_db</span><span class="p">,</span> <span class="n">db</span>
<span class="kn">from</span> <span class="nn">server</span> <span class="kn">import</span> <span class="n">app</span>


<span class="k">def</span> <span class="nf">load_users</span><span class="p">():</span>
    <span class="sd">"""Load users from u.user into database."""</span>

    <span class="k">print</span> <span class="s2">"Users"</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s2">"seed_data/u.user"</span><span class="p">)):</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
        <span class="n">user_id</span><span class="p">,</span> <span class="n">age</span><span class="p">,</span> <span class="n">gender</span><span class="p">,</span> <span class="n">occupation</span><span class="p">,</span> <span class="n">zipcode</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"|"</span><span class="p">)</span>

        <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">age</span><span class="o">=</span><span class="n">age</span><span class="p">,</span>
                    <span class="n">zipcode</span><span class="o">=</span><span class="n">zipcode</span><span class="p">)</span>

        <span class="c1"># We need to add to the session or it won't ever be stored</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>

        <span class="c1"># provide some sense of progress</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">i</span>

    <span class="c1"># Once we're done, we should commit our work</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">load_movies</span><span class="p">():</span>
    <span class="sd">"""Load movies from u.item into database."""</span>

    <span class="k">print</span> <span class="s2">"Movies"</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s2">"seed_data/u.item"</span><span class="p">)):</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>

        <span class="c1"># clever -- we can unpack part of the row!</span>
        <span class="n">movie_id</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">released_str</span><span class="p">,</span> <span class="n">junk</span><span class="p">,</span> <span class="n">imdb_url</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"|"</span><span class="p">)[:</span><span class="mi">5</span><span class="p">]</span>

        <span class="c1"># The date is in the file as daynum-month_abbreviation-year;</span>
        <span class="c1"># we need to convert it to an actual datetime object.</span>

        <span class="k">if</span> <span class="n">released_str</span><span class="p">:</span>
            <span class="n">released_at</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">released_str</span><span class="p">,</span> <span class="s2">"</span><span class="si">%d</span><span class="s2">-%b-%Y"</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">released_at</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c1"># Remove the (YEAR) from the end of the title.</span>

        <span class="n">title</span> <span class="o">=</span> <span class="n">title</span><span class="p">[:</span><span class="o">-</span><span class="mi">7</span><span class="p">]</span>   <span class="c1"># " (YEAR)" == 7</span>

        <span class="n">movie</span> <span class="o">=</span> <span class="n">Movie</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>
                      <span class="n">released_at</span><span class="o">=</span><span class="n">released_at</span><span class="p">,</span>
                      <span class="n">imdb_url</span><span class="o">=</span><span class="n">imdb_url</span><span class="p">)</span>

        <span class="c1"># We need to add to the session or it won't ever be stored</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">movie</span><span class="p">)</span>

        <span class="c1"># provide some sense of progress</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">i</span>

    <span class="c1"># Once we're done, we should commit our work</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">load_ratings</span><span class="p">():</span>
    <span class="sd">"""Load ratings from u.data into database."""</span>

    <span class="k">print</span> <span class="s2">"Ratings"</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s2">"seed_data/u.data"</span><span class="p">)):</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>

        <span class="n">user_id</span><span class="p">,</span> <span class="n">movie_id</span><span class="p">,</span> <span class="n">score</span><span class="p">,</span> <span class="n">timestamp</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"</span><span class="se">\t</span><span class="s2">"</span><span class="p">)</span>

        <span class="n">user_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">movie_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">movie_id</span><span class="p">)</span>
        <span class="n">score</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>

        <span class="c1"># We don't care about the timestamp, so we'll ignore this</span>

        <span class="n">rating</span> <span class="o">=</span> <span class="n">Rating</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span>
                        <span class="n">movie_id</span><span class="o">=</span><span class="n">movie_id</span><span class="p">,</span>
                        <span class="n">score</span><span class="o">=</span><span class="n">score</span><span class="p">)</span>

        <span class="c1"># We need to add to the session or it won't ever be stored</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">rating</span><span class="p">)</span>

        <span class="c1"># provide some sense of progress</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">1000</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">i</span>

            <span class="c1"># An optimization: if we commit after every add, the database</span>
            <span class="c1"># will do a lot of work committing each record. However, if we</span>
            <span class="c1"># wait until the end, on computers with smaller amounts of</span>
            <span class="c1"># memory, it might thrash around. By committing every 1,000th</span>
            <span class="c1"># add, we'll strike a good balance.</span>

            <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="c1"># Once we're done, we should commit our work</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">set_val_user_id</span><span class="p">():</span>
    <span class="sd">"""Set value for the next user_id after seeding database"""</span>

    <span class="c1"># Get the Max user_id in the database</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">user_id</span><span class="p">))</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>
    <span class="n">max_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1"># Set the value for the next user_id to be max_id + 1</span>
    <span class="n">query</span> <span class="o">=</span> <span class="s2">"SELECT setval('users_user_id_seq', :new_id)"</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">{</span><span class="s1">'new_id'</span><span class="p">:</span> <span class="n">max_id</span> <span class="o">+</span> <span class="mi">1</span><span class="p">})</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="n">connect_to_db</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">create_all</span><span class="p">()</span>

    <span class="n">load_users</span><span class="p">()</span>
    <span class="n">load_movies</span><span class="p">()</span>
    <span class="n">load_ratings</span><span class="p">()</span>
    <span class="n">set_val_user_id</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="end-of-step-2">
<h2>End of Step 2</h2>
<div class="literal-block-wrapper container" id="id5">
<div class="code-block-caption"><span class="caption-text">step-2/model.py</span></div>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="sd">"""Models and database functions for Ratings project."""</span>

<span class="kn">from</span> <span class="nn">flask_sqlalchemy</span> <span class="kn">import</span> <span class="n">SQLAlchemy</span>

<span class="c1"># This is the connection to the PostgreSQL database; we're getting</span>
<span class="c1"># this through the Flask-SQLAlchemy helper library. On this, we can</span>
<span class="c1"># find the `session` object, where we do most of our interactions</span>
<span class="c1"># (like committing, etc.)</span>

<span class="n">db</span> <span class="o">=</span> <span class="n">SQLAlchemy</span><span class="p">()</span>


<span class="c1">#####################################################################</span>
<span class="c1"># Model definitions</span>

<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="sd">"""User of ratings website."""</span>

    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">"users"</span>

    <span class="n">user_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span>
                        <span class="n">autoincrement</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                        <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">64</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">64</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">age</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">zipcode</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">15</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""Provide helpful representation when printed."""</span>

        <span class="k">return</span> <span class="s2">"&lt;User user_id=</span><span class="si">%s</span><span class="s2"> email=</span><span class="si">%s</span><span class="s2">&gt;"</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_id</span><span class="p">,</span>
                                               <span class="bp">self</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Movie</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="sd">"""Movie on ratings website."""</span>

    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">"movies"</span>

    <span class="n">movie_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span>
                         <span class="n">autoincrement</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                         <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">100</span><span class="p">))</span>
    <span class="n">released_at</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">DateTime</span><span class="p">)</span>
    <span class="n">imdb_url</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">200</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""Provide helpful representation when printed."""</span>

        <span class="k">return</span> <span class="s2">"&lt;Movie movie_id=</span><span class="si">%s</span><span class="s2"> title=</span><span class="si">%s</span><span class="s2">&gt;"</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">movie_id</span><span class="p">,</span>
                                                 <span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Rating</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="sd">"""Rating of a movie by a user."""</span>

    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">"ratings"</span>

    <span class="n">rating_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span>
                          <span class="n">autoincrement</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                          <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">movie_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span>
                         <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">'movies.movie_id'</span><span class="p">))</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">'users.user_id'</span><span class="p">))</span>
    <span class="n">score</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">)</span>

    <span class="c1"># Define relationship to user</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span><span class="s2">"User"</span><span class="p">,</span>
                           <span class="n">backref</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">backref</span><span class="p">(</span><span class="s2">"ratings"</span><span class="p">,</span>
                                              <span class="n">order_by</span><span class="o">=</span><span class="n">rating_id</span><span class="p">))</span>

    <span class="c1"># Define relationship to movie</span>
    <span class="n">movie</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span><span class="s2">"Movie"</span><span class="p">,</span>
                            <span class="n">backref</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">backref</span><span class="p">(</span><span class="s2">"ratings"</span><span class="p">,</span>
                                               <span class="n">order_by</span><span class="o">=</span><span class="n">rating_id</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""Provide helpful representation when printed."""</span>

        <span class="n">s</span> <span class="o">=</span> <span class="s2">"&lt;Rating rating_id=</span><span class="si">%s</span><span class="s2"> movie_id=</span><span class="si">%s</span><span class="s2"> user_id=</span><span class="si">%s</span><span class="s2"> score=</span><span class="si">%s</span><span class="s2">&gt;"</span>
        <span class="k">return</span> <span class="n">s</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rating_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">movie_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_id</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">score</span><span class="p">)</span>


<span class="c1">#####################################################################</span>
<span class="c1"># Helper functions</span>

<span class="k">def</span> <span class="nf">connect_to_db</span><span class="p">(</span><span class="n">app</span><span class="p">):</span>
    <span class="sd">"""Connect the database to our Flask app."""</span>

    <span class="c1"># Configure to use our PostgreSQL database</span>
    <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">'SQLALCHEMY_DATABASE_URI'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'postgresql:///ratings'</span>
    <span class="n">db</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="n">app</span>
    <span class="n">db</span><span class="o">.</span><span class="n">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="c1"># As a convenience, if we run this module interactively, it will</span>
    <span class="c1"># leave you in a state of being able to work with the database</span>
    <span class="c1"># directly.</span>

    <span class="kn">from</span> <span class="nn">server</span> <span class="kn">import</span> <span class="n">app</span>
    <span class="n">connect_to_db</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="k">print</span> <span class="s2">"Connected to DB."</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper container" id="id6">
<div class="code-block-caption"><span class="caption-text">step-2/seed.py</span></div>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="sd">"""Utility file to seed ratings database from MovieLens data in seed_data/"""</span>

<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">func</span>

<span class="kn">from</span> <span class="nn">model</span> <span class="kn">import</span> <span class="n">User</span><span class="p">,</span> <span class="n">Rating</span><span class="p">,</span> <span class="n">Movie</span><span class="p">,</span> <span class="n">connect_to_db</span><span class="p">,</span> <span class="n">db</span>
<span class="kn">from</span> <span class="nn">server</span> <span class="kn">import</span> <span class="n">app</span>


<span class="k">def</span> <span class="nf">load_users</span><span class="p">():</span>
    <span class="sd">"""Load users from u.user into database."""</span>

    <span class="k">print</span> <span class="s2">"Users"</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s2">"seed_data/u.user"</span><span class="p">)):</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
        <span class="n">user_id</span><span class="p">,</span> <span class="n">age</span><span class="p">,</span> <span class="n">gender</span><span class="p">,</span> <span class="n">occupation</span><span class="p">,</span> <span class="n">zipcode</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"|"</span><span class="p">)</span>

        <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">age</span><span class="o">=</span><span class="n">age</span><span class="p">,</span>
                    <span class="n">zipcode</span><span class="o">=</span><span class="n">zipcode</span><span class="p">)</span>

        <span class="c1"># We need to add to the session or it won't ever be stored</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>

        <span class="c1"># provide some sense of progress</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">i</span>

    <span class="c1"># Once we're done, we should commit our work</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">load_movies</span><span class="p">():</span>
    <span class="sd">"""Load movies from u.item into database."""</span>

    <span class="k">print</span> <span class="s2">"Movies"</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s2">"seed_data/u.item"</span><span class="p">)):</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>

        <span class="c1"># clever -- we can unpack part of the row!</span>
        <span class="n">movie_id</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">released_str</span><span class="p">,</span> <span class="n">junk</span><span class="p">,</span> <span class="n">imdb_url</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"|"</span><span class="p">)[:</span><span class="mi">5</span><span class="p">]</span>

        <span class="c1"># The date is in the file as daynum-month_abbreviation-year;</span>
        <span class="c1"># we need to convert it to an actual datetime object.</span>

        <span class="k">if</span> <span class="n">released_str</span><span class="p">:</span>
            <span class="n">released_at</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">released_str</span><span class="p">,</span> <span class="s2">"</span><span class="si">%d</span><span class="s2">-%b-%Y"</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">released_at</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c1"># Remove the (YEAR) from the end of the title.</span>

        <span class="n">title</span> <span class="o">=</span> <span class="n">title</span><span class="p">[:</span><span class="o">-</span><span class="mi">7</span><span class="p">]</span>   <span class="c1"># " (YEAR)" == 7</span>

        <span class="n">movie</span> <span class="o">=</span> <span class="n">Movie</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>
                      <span class="n">released_at</span><span class="o">=</span><span class="n">released_at</span><span class="p">,</span>
                      <span class="n">imdb_url</span><span class="o">=</span><span class="n">imdb_url</span><span class="p">)</span>

        <span class="c1"># We need to add to the session or it won't ever be stored</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">movie</span><span class="p">)</span>

        <span class="c1"># provide some sense of progress</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">i</span>

    <span class="c1"># Once we're done, we should commit our work</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">load_ratings</span><span class="p">():</span>
    <span class="sd">"""Load ratings from u.data into database."""</span>

    <span class="k">print</span> <span class="s2">"Ratings"</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s2">"seed_data/u.data"</span><span class="p">)):</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>

        <span class="n">user_id</span><span class="p">,</span> <span class="n">movie_id</span><span class="p">,</span> <span class="n">score</span><span class="p">,</span> <span class="n">timestamp</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"</span><span class="se">\t</span><span class="s2">"</span><span class="p">)</span>

        <span class="n">user_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">movie_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">movie_id</span><span class="p">)</span>
        <span class="n">score</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>

        <span class="c1"># We don't care about the timestamp, so we'll ignore this</span>

        <span class="n">rating</span> <span class="o">=</span> <span class="n">Rating</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span>
                        <span class="n">movie_id</span><span class="o">=</span><span class="n">movie_id</span><span class="p">,</span>
                        <span class="n">score</span><span class="o">=</span><span class="n">score</span><span class="p">)</span>

        <span class="c1"># We need to add to the session or it won't ever be stored</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">rating</span><span class="p">)</span>

        <span class="c1"># provide some sense of progress</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">1000</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">i</span>

            <span class="c1"># An optimization: if we commit after every add, the database</span>
            <span class="c1"># will do a lot of work committing each record. However, if we</span>
            <span class="c1"># wait until the end, on computers with smaller amounts of</span>
            <span class="c1"># memory, it might thrash around. By committing every 1,000th</span>
            <span class="c1"># add, we'll strike a good balance.</span>

            <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="c1"># Once we're done, we should commit our work</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">set_val_user_id</span><span class="p">():</span>
    <span class="sd">"""Set value for the next user_id after seeding database"""</span>

    <span class="c1"># Get the Max user_id in the database</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">user_id</span><span class="p">))</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>
    <span class="n">max_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1"># Set the value for the next user_id to be max_id + 1</span>
    <span class="n">query</span> <span class="o">=</span> <span class="s2">"SELECT setval('users_user_id_seq', :new_id)"</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">{</span><span class="s1">'new_id'</span><span class="p">:</span> <span class="n">max_id</span> <span class="o">+</span> <span class="mi">1</span><span class="p">})</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="n">connect_to_db</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">create_all</span><span class="p">()</span>

    <span class="n">load_users</span><span class="p">()</span>
    <span class="n">load_movies</span><span class="p">()</span>
    <span class="n">load_ratings</span><span class="p">()</span>
    <span class="n">set_val_user_id</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper container" id="id7">
<div class="code-block-caption"><span class="caption-text">step-2/server.py</span></div>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="sd">"""Movie Ratings."""</span>

<span class="kn">from</span> <span class="nn">jinja2</span> <span class="kn">import</span> <span class="n">StrictUndefined</span>

<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">render_template</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">flash</span><span class="p">,</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">session</span>
<span class="kn">from</span> <span class="nn">flask_debugtoolbar</span> <span class="kn">import</span> <span class="n">DebugToolbarExtension</span>

<span class="kn">from</span> <span class="nn">model</span> <span class="kn">import</span> <span class="n">connect_to_db</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">User</span><span class="p">,</span> <span class="n">Movie</span><span class="p">,</span> <span class="n">Rating</span>


<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="c1"># Required to use Flask sessions and the debug toolbar</span>
<span class="n">app</span><span class="o">.</span><span class="n">secret_key</span> <span class="o">=</span> <span class="s2">"ABC"</span>

<span class="c1"># Normally, if you use an undefined variable in Jinja2, it fails silently.</span>
<span class="c1"># This is horrible. Fix this so that, instead, it raises an error.</span>
<span class="n">app</span><span class="o">.</span><span class="n">jinja_env</span><span class="o">.</span><span class="n">undefined</span> <span class="o">=</span> <span class="n">StrictUndefined</span>


<span class="nd">@app.route</span><span class="p">(</span><span class="s1">'/'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="sd">"""Homepage."""</span>

    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s2">"homepage.html"</span><span class="p">)</span>


<span class="nd">@app.route</span><span class="p">(</span><span class="s1">'/register'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">'GET'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">register_form</span><span class="p">():</span>
    <span class="sd">"""Show form for user signup."""</span>

    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s2">"register_form.html"</span><span class="p">)</span>


<span class="nd">@app.route</span><span class="p">(</span><span class="s1">'/register'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">'POST'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">register_process</span><span class="p">():</span>
    <span class="sd">"""Process registration."""</span>

    <span class="c1"># Get form variables</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s2">"email"</span><span class="p">]</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s2">"password"</span><span class="p">]</span>
    <span class="n">age</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s2">"age"</span><span class="p">])</span>
    <span class="n">zipcode</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s2">"zipcode"</span><span class="p">]</span>

    <span class="n">new_user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">,</span> <span class="n">age</span><span class="o">=</span><span class="n">age</span><span class="p">,</span> <span class="n">zipcode</span><span class="o">=</span><span class="n">zipcode</span><span class="p">)</span>

    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">new_user</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="n">flash</span><span class="p">(</span><span class="s2">"User </span><span class="si">%s</span><span class="s2"> added."</span> <span class="o">%</span> <span class="n">email</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">"/"</span><span class="p">)</span>


<span class="nd">@app.route</span><span class="p">(</span><span class="s1">'/login'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">'GET'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">login_form</span><span class="p">():</span>
    <span class="sd">"""Show login form."""</span>

    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s2">"login_form.html"</span><span class="p">)</span>


<span class="nd">@app.route</span><span class="p">(</span><span class="s1">'/login'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">'POST'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">login_process</span><span class="p">():</span>
    <span class="sd">"""Process login."""</span>

    <span class="c1"># Get form variables</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s2">"email"</span><span class="p">]</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s2">"password"</span><span class="p">]</span>

    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
        <span class="n">flash</span><span class="p">(</span><span class="s2">"No such user"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">"/login"</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">password</span> <span class="o">!=</span> <span class="n">password</span><span class="p">:</span>
        <span class="n">flash</span><span class="p">(</span><span class="s2">"Incorrect password"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">"/login"</span><span class="p">)</span>

    <span class="n">session</span><span class="p">[</span><span class="s2">"user_id"</span><span class="p">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">user_id</span>

    <span class="n">flash</span><span class="p">(</span><span class="s2">"Logged in"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">"/users/</span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="n">user</span><span class="o">.</span><span class="n">user_id</span><span class="p">)</span>


<span class="nd">@app.route</span><span class="p">(</span><span class="s1">'/logout'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">logout</span><span class="p">():</span>
    <span class="sd">"""Log out."""</span>

    <span class="k">del</span> <span class="n">session</span><span class="p">[</span><span class="s2">"user_id"</span><span class="p">]</span>
    <span class="n">flash</span><span class="p">(</span><span class="s2">"Logged Out."</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">"/"</span><span class="p">)</span>


<span class="nd">@app.route</span><span class="p">(</span><span class="s2">"/users"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">user_list</span><span class="p">():</span>
    <span class="sd">"""Show list of users."""</span>

    <span class="n">users</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s2">"user_list.html"</span><span class="p">,</span> <span class="n">users</span><span class="o">=</span><span class="n">users</span><span class="p">)</span>


<span class="nd">@app.route</span><span class="p">(</span><span class="s2">"/users/&lt;int:user_id&gt;"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">user_detail</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>
    <span class="sd">"""Show info about user."""</span>

    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s2">"user.html"</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">)</span>


<span class="nd">@app.route</span><span class="p">(</span><span class="s2">"/movies"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">movie_list</span><span class="p">():</span>
    <span class="sd">"""Show list of movies."""</span>

    <span class="n">movies</span> <span class="o">=</span> <span class="n">Movie</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">'title'</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s2">"movie_list.html"</span><span class="p">,</span> <span class="n">movies</span><span class="o">=</span><span class="n">movies</span><span class="p">)</span>


<span class="nd">@app.route</span><span class="p">(</span><span class="s2">"/movies/&lt;int:movie_id&gt;"</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">'GET'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">movie_detail</span><span class="p">(</span><span class="n">movie_id</span><span class="p">):</span>
    <span class="sd">"""Show info about movie.</span>

<span class="sd">    If a user is logged in, let them add/edit a rating.</span>
<span class="sd">    """</span>

    <span class="n">movie</span> <span class="o">=</span> <span class="n">Movie</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">movie_id</span><span class="p">)</span>

    <span class="n">user_id</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"user_id"</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">user_id</span><span class="p">:</span>
        <span class="n">user_rating</span> <span class="o">=</span> <span class="n">Rating</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span>
            <span class="n">movie_id</span><span class="o">=</span><span class="n">movie_id</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">user_rating</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s2">"movie.html"</span><span class="p">,</span>
                           <span class="n">movie</span><span class="o">=</span><span class="n">movie</span><span class="p">,</span>
                           <span class="n">user_rating</span><span class="o">=</span><span class="n">user_rating</span><span class="p">)</span>


<span class="nd">@app.route</span><span class="p">(</span><span class="s2">"/movies/&lt;int:movie_id&gt;"</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">'POST'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">movie_detail_process</span><span class="p">(</span><span class="n">movie_id</span><span class="p">):</span>
    <span class="sd">"""Add/edit a rating."""</span>

    <span class="c1"># Get form variables</span>
    <span class="n">score</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s2">"score"</span><span class="p">])</span>

    <span class="n">user_id</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"user_id"</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">user_id</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">"No user logged in."</span><span class="p">)</span>

    <span class="n">rating</span> <span class="o">=</span> <span class="n">Rating</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span> <span class="n">movie_id</span><span class="o">=</span><span class="n">movie_id</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">rating</span><span class="p">:</span>
        <span class="n">rating</span><span class="o">.</span><span class="n">score</span> <span class="o">=</span> <span class="n">score</span>
        <span class="n">flash</span><span class="p">(</span><span class="s2">"Rating updated."</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">rating</span> <span class="o">=</span> <span class="n">Rating</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span> <span class="n">movie_id</span><span class="o">=</span><span class="n">movie_id</span><span class="p">,</span> <span class="n">score</span><span class="o">=</span><span class="n">score</span><span class="p">)</span>
        <span class="n">flash</span><span class="p">(</span><span class="s2">"Rating added."</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">rating</span><span class="p">)</span>

    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">"/movies/</span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="n">movie_id</span><span class="p">)</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="c1"># We have to set debug=True here, since it has to be True at the point</span>
    <span class="c1"># that we invoke the DebugToolbarExtension</span>
    <span class="n">app</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="n">connect_to_db</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>

    <span class="c1"># Use the DebugToolbar</span>
    <span class="n">DebugToolbarExtension</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>

    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="templates">
<h3>Templates</h3>
<div class="literal-block-wrapper container" id="id8">
<div class="code-block-caption"><span class="caption-text">step-2/templates/base.html</span></div>
<div class="highlight-jinja"><div class="highlight"><pre><span></span><span class="x">&lt;!doctype html&gt;</span>
<span class="x">&lt;html&gt;</span>
<span class="x">&lt;head&gt;</span>
<span class="x">    &lt;title&gt;Ratings&lt;/title&gt;</span>
<span class="x">&lt;/head&gt;</span>
<span class="x">&lt;body&gt;</span>

<span class="x">Ratings</span>

<span class="cp">{%</span> <span class="k">if</span> <span class="s2">"user_id"</span> <span class="k">in</span> <span class="nv">session</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">    &lt;a href="/logout"&gt;Logout&lt;/a&gt;</span>
<span class="cp">{%</span> <span class="k">else</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">    &lt;a href="/login"&gt;Login&lt;/a&gt;</span>
<span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span><span class="x"></span>

<span class="x">&lt;hr&gt;</span>

<span class="cp">{%</span> <span class="k">for</span> <span class="nv">flash</span> <span class="k">in</span> <span class="nv">get_flashed_messages</span><span class="o">()</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">  </span><span class="cp">{{</span> <span class="nv">flash</span> <span class="cp">}}</span><span class="x"></span>
<span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span><span class="x"></span>

<span class="cp">{%</span> <span class="k">block</span> <span class="nv">content</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">    Put your body here.</span>
<span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span><span class="x"></span>

<span class="x">&lt;/body&gt;</span>
<span class="x">&lt;/html&gt;</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper container" id="id9">
<div class="code-block-caption"><span class="caption-text">step-2/templates/homepage.html</span></div>
<div class="highlight-jinja"><div class="highlight"><pre><span></span><span class="cp">{%</span> <span class="k">extends</span> <span class="s1">'base.html'</span> <span class="cp">%}</span><span class="x"></span>
<span class="cp">{%</span> <span class="k">block</span> <span class="nv">content</span> <span class="cp">%}</span><span class="x"></span>

<span class="x">  &lt;h1&gt;Ratings&lt;/h1&gt;</span>

<span class="x">  &lt;h2&gt;Movies&lt;/h2&gt;</span>
<span class="x">  &lt;p&gt;&lt;a href="/movies"&gt;View all movies&lt;/a&gt;&lt;/p&gt;</span>

<span class="x">  &lt;h2&gt;Users&lt;/h2&gt;</span>
<span class="x">  &lt;p&gt;&lt;a href="/users"&gt;View all users&lt;/a&gt;&lt;/p&gt;</span>

<span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span><span class="x"></span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper container" id="id10">
<div class="code-block-caption"><span class="caption-text">step-2/templates/login_form.html</span></div>
<div class="highlight-jinja"><div class="highlight"><pre><span></span><span class="cp">{%</span> <span class="k">extends</span> <span class="s1">'base.html'</span> <span class="cp">%}</span><span class="x"></span>
<span class="cp">{%</span> <span class="k">block</span> <span class="nv">content</span> <span class="cp">%}</span><span class="x"></span>

<span class="x">    &lt;h1&gt;Login&lt;/h1&gt;</span>
<span class="x">    &lt;form action="/login" method="POST"&gt;</span>

<span class="x">        &lt;div&gt;</span>
<span class="x">            &lt;label&gt;Email:</span>
<span class="x">                &lt;input type="email" name="email" required&gt;</span>
<span class="x">            &lt;/label&gt;</span>
<span class="x">        &lt;/div&gt;</span>

<span class="x">        &lt;div&gt;</span>
<span class="x">            &lt;label&gt;Password:</span>
<span class="x">                &lt;input type="password" name="password" required&gt;</span>
<span class="x">            &lt;/label&gt;</span>
<span class="x">        &lt;/div&gt;</span>

<span class="x">        &lt;div&gt;</span>
<span class="x">            &lt;input type="submit" value="Log In"&gt;</span>
<span class="x">        &lt;/div&gt;</span>

<span class="x">    &lt;/form&gt;</span>
<span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span><span class="x"></span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper container" id="id11">
<div class="code-block-caption"><span class="caption-text">step-2/templates/movie.html</span></div>
<div class="highlight-jinja"><div class="highlight"><pre><span></span><span class="cp">{%</span> <span class="k">extends</span> <span class="s1">'base.html'</span> <span class="cp">%}</span><span class="x"></span>
<span class="cp">{%</span> <span class="k">block</span> <span class="nv">content</span> <span class="cp">%}</span><span class="x"></span>

<span class="x">    &lt;h1&gt;</span><span class="cp">{{</span> <span class="nv">movie.title</span> <span class="cp">}}</span><span class="x">&lt;/h1&gt;</span>
<span class="x">    &lt;p&gt;Released: </span><span class="cp">{{</span> <span class="nv">movie.released_at</span> <span class="cp">}}</span><span class="x">&lt;/p&gt;</span>
<span class="x">    &lt;p&gt;IMDB: &lt;a href="</span><span class="cp">{{</span> <span class="nv">movie.imdb_url</span> <span class="cp">}}</span><span class="x">"&gt;</span><span class="cp">{{</span> <span class="nv">movie.imdb_url</span> <span class="cp">}}</span><span class="x">&lt;/a&gt;&lt;/p&gt;</span>

<span class="x">  </span><span class="cp">{%</span> <span class="k">if</span> <span class="nv">movie.ratings</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">      &lt;h2&gt;Ratings&lt;/h2&gt;</span>
<span class="x">      &lt;ul&gt;</span>
<span class="x">        </span><span class="cp">{%</span> <span class="k">for</span> <span class="nv">rating</span> <span class="k">in</span> <span class="nv">movie.ratings</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">            &lt;li&gt;</span>
<span class="x">                &lt;a href="/users/</span><span class="cp">{{</span> <span class="nv">rating.user_id</span> <span class="cp">}}</span><span class="x">"&gt;</span><span class="cp">{{</span> <span class="nv">rating.user_id</span> <span class="cp">}}</span><span class="x">&lt;/a&gt;</span>
<span class="x">                rated </span><span class="cp">{{</span> <span class="nv">rating.score</span> <span class="cp">}}</span><span class="x">&lt;/li&gt;</span>
<span class="x">        </span><span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">      &lt;/ul&gt;</span>
<span class="x">  </span><span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span><span class="x"></span>

<span class="x">  </span><span class="cp">{%</span> <span class="k">if</span> <span class="s2">"user_id"</span> <span class="k">in</span> <span class="nv">session</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">    &lt;h2&gt;Your Rating&lt;/h2&gt;</span>
<span class="x">    </span><span class="cp">{%</span> <span class="k">if</span> <span class="nv">user_rating</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">        &lt;p&gt;You currently rate this a </span><span class="cp">{{</span> <span class="nv">user_rating.score</span> <span class="cp">}}</span><span class="x">&lt;/p&gt;</span>
<span class="x">    </span><span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">      &lt;form action="/movies/</span><span class="cp">{{</span> <span class="nv">movie.movie_id</span> <span class="cp">}}</span><span class="x">" method="POST"&gt;</span>
<span class="x">          &lt;label&gt;Rating:</span>
<span class="x">              &lt;input type="number" name="score"&gt;</span>
<span class="x">          &lt;/label&gt;</span>
<span class="x">          &lt;input type="submit" value="Rate"&gt;</span>
<span class="x">      &lt;/form&gt;</span>
<span class="x">  </span><span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span><span class="x"></span>

<span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span><span class="x"></span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper container" id="id12">
<div class="code-block-caption"><span class="caption-text">step-2/templates/movie_list.html</span></div>
<div class="highlight-jinja"><div class="highlight"><pre><span></span><span class="cp">{%</span> <span class="k">extends</span> <span class="s1">'base.html'</span> <span class="cp">%}</span><span class="x"></span>
<span class="cp">{%</span> <span class="k">block</span> <span class="nv">content</span> <span class="cp">%}</span><span class="x"></span>

<span class="x">  &lt;h1&gt;Movies&lt;/h1&gt;</span>
<span class="x">  &lt;ul&gt;</span>
<span class="x">  </span><span class="cp">{%</span> <span class="k">for</span> <span class="nv">movie</span> <span class="k">in</span> <span class="nv">movies</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">    &lt;li&gt;</span>
<span class="x">      &lt;a href="/movies/</span><span class="cp">{{</span> <span class="nv">movie.movie_id</span> <span class="cp">}}</span><span class="x">"&gt;</span><span class="cp">{{</span> <span class="nv">movie.title</span> <span class="cp">}}</span><span class="x">&lt;/a&gt;</span>
<span class="x">    &lt;/li&gt;</span>
<span class="x">  </span><span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">  &lt;/ul&gt;</span>
<span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span><span class="x"></span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper container" id="id13">
<div class="code-block-caption"><span class="caption-text">step-2/templates/register_form.html</span></div>
<div class="highlight-jinja"><div class="highlight"><pre><span></span><span class="cp">{%</span> <span class="k">extends</span> <span class="s1">'base.html'</span> <span class="cp">%}</span><span class="x"></span>
<span class="cp">{%</span> <span class="k">block</span> <span class="nv">content</span> <span class="cp">%}</span><span class="x"></span>

<span class="x">&lt;h1&gt;Register&lt;/h1&gt;</span>

<span class="x">&lt;form action="register" method="POST"&gt;</span>

<span class="x">    &lt;div&gt;</span>
<span class="x">        &lt;label&gt;</span>
<span class="x">            Email</span>
<span class="x">            &lt;input type="email" name="email"&gt;</span>
<span class="x">        &lt;/label&gt;</span>
<span class="x">    &lt;/div&gt;</span>

<span class="x">    &lt;div&gt;</span>
<span class="x">        &lt;label&gt;</span>
<span class="x">            Password</span>
<span class="x">            &lt;input type="password" name="password"&gt;</span>
<span class="x">        &lt;/label&gt;</span>
<span class="x">    &lt;/div&gt;</span>

<span class="x">    &lt;div&gt;</span>
<span class="x">        &lt;label&gt;</span>
<span class="x">            Age</span>
<span class="x">            &lt;input type="number" name="age"&gt;</span>
<span class="x">        &lt;/label&gt;</span>
<span class="x">    &lt;/div&gt;</span>

<span class="x">    &lt;div&gt;</span>
<span class="x">        &lt;label&gt;</span>
<span class="x">            Zipcode</span>
<span class="x">            &lt;input type="text" name="zipcode"&gt;</span>
<span class="x">        &lt;/label&gt;</span>
<span class="x">    &lt;/div&gt;</span>

<span class="x">    &lt;div&gt;</span>
<span class="x">        &lt;input type="submit" value="Register"&gt;</span>
<span class="x">    &lt;/div&gt;</span>

<span class="x">&lt;/form&gt;</span>

<span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span><span class="x"></span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper container" id="id14">
<div class="code-block-caption"><span class="caption-text">step-2/templates/user.html</span></div>
<div class="highlight-jinja"><div class="highlight"><pre><span></span><span class="cp">{%</span> <span class="k">extends</span> <span class="s1">'base.html'</span> <span class="cp">%}</span><span class="x"></span>
<span class="cp">{%</span> <span class="k">block</span> <span class="nv">content</span> <span class="cp">%}</span><span class="x"></span>

<span class="x">  &lt;h1&gt;</span><span class="cp">{{</span> <span class="nv">user.email</span> <span class="cp">}}</span><span class="x"> (</span><span class="cp">{{</span> <span class="nv">user.user_id</span> <span class="cp">}}</span><span class="x">)&lt;/h1&gt;</span>

<span class="x">  &lt;p&gt;Age: </span><span class="cp">{{</span> <span class="nv">user.age</span> <span class="cp">}}</span><span class="x">&lt;/p&gt;</span>
<span class="x">  &lt;p&gt;Zipcode: </span><span class="cp">{{</span> <span class="nv">user.zipcode</span> <span class="cp">}}</span><span class="x">&lt;/p&gt;</span>

<span class="x">  </span><span class="cp">{%</span> <span class="k">if</span> <span class="nv">user.ratings</span> <span class="cp">%}</span><span class="x"></span>

<span class="x">    &lt;h2&gt;Ratings&lt;/h2&gt;</span>
<span class="x">    &lt;ul&gt;</span>
<span class="x">    </span><span class="cp">{%</span> <span class="k">for</span> <span class="nv">rating</span> <span class="k">in</span> <span class="nv">user.ratings</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">      &lt;li&gt;</span>
<span class="x">        &lt;a href="/movies/</span><span class="cp">{{</span> <span class="nv">rating.movie_id</span> <span class="cp">}}</span><span class="x">"&gt;</span><span class="cp">{{</span> <span class="nv">rating.movie.title</span> <span class="cp">}}</span><span class="x">&lt;/a&gt;</span>
<span class="x">        was rated </span><span class="cp">{{</span> <span class="nv">rating.score</span> <span class="cp">}}</span><span class="x"></span>
<span class="x">      &lt;/li&gt;</span>
<span class="x">    </span><span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">    &lt;/ul&gt;</span>
<span class="x">  </span><span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span><span class="x"></span>

<span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span><span class="x"></span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper container" id="id15">
<div class="code-block-caption"><span class="caption-text">step-2/templates/user_list.html</span></div>
<div class="highlight-jinja"><div class="highlight"><pre><span></span><span class="cp">{%</span> <span class="k">extends</span> <span class="s1">'base.html'</span> <span class="cp">%}</span><span class="x"></span>
<span class="cp">{%</span> <span class="k">block</span> <span class="nv">content</span> <span class="cp">%}</span><span class="x"></span>

<span class="x">    &lt;h2&gt;Users&lt;/h2&gt;</span>
<span class="x">    &lt;ul&gt;</span>
<span class="x">      </span><span class="cp">{%</span> <span class="k">for</span> <span class="nv">user</span> <span class="k">in</span> <span class="nv">users</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">          &lt;li&gt;</span>
<span class="x">              &lt;a href="/users/</span><span class="cp">{{</span> <span class="nv">user.user_id</span> <span class="cp">}}</span><span class="x">"&gt;</span>
<span class="x">                </span><span class="cp">{{</span> <span class="nv">user.email</span> <span class="cp">}}</span><span class="x"> (</span><span class="cp">{{</span> <span class="nv">user.user_id</span> <span class="cp">}}</span><span class="x">)</span>
<span class="x">              &lt;/a&gt;</span>
<span class="x">          &lt;/li&gt;</span>
<span class="x">      </span><span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">    &lt;/ul&gt;</span>

<span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span><span class="x"></span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="end-of-step-3">
<h2>End of Step 3</h2>
<div class="literal-block-wrapper container" id="id16">
<div class="code-block-caption"><span class="caption-text">step-3/model.py</span></div>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="sd">"""Models and database functions for Ratings project."""</span>

<span class="kn">from</span> <span class="nn">flask_sqlalchemy</span> <span class="kn">import</span> <span class="n">SQLAlchemy</span>

<span class="kn">import</span> <span class="nn">correlation</span>

<span class="c1"># This is the connection to the PostgreSQL database; we're getting this through</span>
<span class="c1"># the Flask-SQLAlchemy helper library. On this, we can find the `session`</span>
<span class="c1"># object, where we do most of our interactions (like committing, etc.)</span>

<span class="n">db</span> <span class="o">=</span> <span class="n">SQLAlchemy</span><span class="p">()</span>


<span class="c1">##############################################################################</span>
<span class="c1"># Model definitions</span>

<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="sd">"""User of ratings website."""</span>

    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">"users"</span>

    <span class="n">user_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">autoincrement</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">64</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">64</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">age</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">zipcode</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">15</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""Provide helpful representation when printed."""</span>

        <span class="k">return</span> <span class="s2">"&lt;User user_id=</span><span class="si">%s</span><span class="s2"> email=</span><span class="si">%s</span><span class="s2">&gt;"</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">predict_rating</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">movie</span><span class="p">):</span>
        <span class="sd">"""Predict user's rating of a movie."""</span>

        <span class="n">other_ratings</span> <span class="o">=</span> <span class="n">movie</span><span class="o">.</span><span class="n">ratings</span>

        <span class="n">similarities</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">similarity</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">user</span><span class="p">),</span> <span class="n">r</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">other_ratings</span>
        <span class="p">]</span>

        <span class="n">similarities</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="n">similarities</span> <span class="o">=</span> <span class="p">[(</span><span class="n">sim</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">sim</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">similarities</span>
                        <span class="k">if</span> <span class="n">sim</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">similarities</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>

        <span class="n">numerator</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">r</span><span class="o">.</span><span class="n">score</span> <span class="o">*</span> <span class="n">sim</span> <span class="k">for</span> <span class="n">sim</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">similarities</span><span class="p">])</span>
        <span class="n">denominator</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">sim</span> <span class="k">for</span> <span class="n">sim</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">similarities</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">numerator</span><span class="o">/</span><span class="n">denominator</span>

    <span class="k">def</span> <span class="nf">similarity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">"""Return Pearson rating for user compared to other user."""</span>

        <span class="n">u_ratings</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">paired_ratings</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ratings</span><span class="p">:</span>
            <span class="n">u_ratings</span><span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">movie_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span>

        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">other</span><span class="o">.</span><span class="n">ratings</span><span class="p">:</span>
            <span class="n">u_r</span> <span class="o">=</span> <span class="n">u_ratings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">movie_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">u_r</span><span class="p">:</span>
                <span class="n">paired_ratings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">(</span><span class="n">u_r</span><span class="o">.</span><span class="n">score</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">score</span><span class="p">)</span> <span class="p">)</span>

        <span class="k">if</span> <span class="n">paired_ratings</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">correlation</span><span class="o">.</span><span class="n">pearson</span><span class="p">(</span><span class="n">paired_ratings</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span>


<span class="k">class</span> <span class="nc">Movie</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="sd">"""Movie on ratings website."""</span>

    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">"movies"</span>

    <span class="n">movie_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">autoincrement</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">100</span><span class="p">))</span>
    <span class="n">released_at</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">DateTime</span><span class="p">)</span>
    <span class="n">imdb_url</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">200</span><span class="p">))</span>
    <span class="n">sequel_of_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">'movies.movie_id'</span><span class="p">))</span>

    <span class="n">sequel_of</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span><span class="s2">"Movie"</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""Provide helpful representation when printed."""</span>

        <span class="k">return</span> <span class="s2">"&lt;Movie movie_id=</span><span class="si">%s</span><span class="s2"> title=</span><span class="si">%s</span><span class="s2">&gt;"</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">movie_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Rating</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="sd">"""Rating of a movie by a user."""</span>

    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">"ratings"</span>

    <span class="n">rating_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">autoincrement</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">movie_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">'movies.movie_id'</span><span class="p">))</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">'users.user_id'</span><span class="p">))</span>
    <span class="n">score</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">)</span>

    <span class="c1"># Define relationship to user</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span><span class="s2">"User"</span><span class="p">,</span>
                           <span class="n">backref</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">backref</span><span class="p">(</span><span class="s2">"ratings"</span><span class="p">,</span> <span class="n">order_by</span><span class="o">=</span><span class="n">rating_id</span><span class="p">))</span>

    <span class="c1"># Define relationship to movie</span>
    <span class="n">movie</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span><span class="s2">"Movie"</span><span class="p">,</span>
                            <span class="n">backref</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">backref</span><span class="p">(</span><span class="s2">"ratings"</span><span class="p">,</span> <span class="n">order_by</span><span class="o">=</span><span class="n">rating_id</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""Provide helpful representation when printed."""</span>

        <span class="k">return</span> <span class="s2">"&lt;Rating rating_id=</span><span class="si">%s</span><span class="s2"> movie_id=</span><span class="si">%s</span><span class="s2"> user_id=</span><span class="si">%s</span><span class="s2"> score=</span><span class="si">%s</span><span class="s2">&gt;"</span> <span class="o">%</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rating_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">movie_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">score</span><span class="p">)</span>


<span class="c1">##############################################################################</span>
<span class="c1"># Helper functions</span>

<span class="k">def</span> <span class="nf">connect_to_db</span><span class="p">(</span><span class="n">app</span><span class="p">):</span>
    <span class="sd">"""Connect the database to our Flask app."""</span>

    <span class="c1"># Configure to use our PostgreSQL database</span>
    <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">'SQLALCHEMY_DATABASE_URI'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'postgresql:///ratings'</span>
    <span class="n">db</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="n">app</span>
    <span class="n">db</span><span class="o">.</span><span class="n">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="c1"># As a convenience, if we run this module interactively, it will leave</span>
    <span class="c1"># you in a state of being able to work with the database directly.</span>

    <span class="kn">from</span> <span class="nn">server</span> <span class="kn">import</span> <span class="n">app</span>
    <span class="n">connect_to_db</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="k">print</span> <span class="s2">"Connected to DB."</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper container" id="id17">
<div class="code-block-caption"><span class="caption-text">step-3/seed.py</span></div>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="sd">"""Utility file to seed ratings database from MovieLens data in seed_data/"""</span>

<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">func</span>

<span class="kn">from</span> <span class="nn">model</span> <span class="kn">import</span> <span class="n">User</span><span class="p">,</span> <span class="n">Rating</span><span class="p">,</span> <span class="n">Movie</span><span class="p">,</span> <span class="n">connect_to_db</span><span class="p">,</span> <span class="n">db</span>
<span class="kn">from</span> <span class="nn">server</span> <span class="kn">import</span> <span class="n">app</span>


<span class="k">def</span> <span class="nf">load_users</span><span class="p">():</span>
    <span class="sd">"""Load users from u.user into database."""</span>

    <span class="k">print</span> <span class="s2">"Users"</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s2">"seed_data/u.user"</span><span class="p">)):</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
        <span class="n">user_id</span><span class="p">,</span> <span class="n">age</span><span class="p">,</span> <span class="n">gender</span><span class="p">,</span> <span class="n">occupation</span><span class="p">,</span> <span class="n">zipcode</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"|"</span><span class="p">)</span>

        <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span>
                    <span class="n">age</span><span class="o">=</span><span class="n">age</span><span class="p">,</span>
                    <span class="n">zipcode</span><span class="o">=</span><span class="n">zipcode</span><span class="p">)</span>

        <span class="c1"># We need to add to the session or it won't ever be stored</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>

        <span class="c1"># provide some sense of progress</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">i</span>

    <span class="c1"># Once we're done, we should commit our work</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">load_movies</span><span class="p">():</span>
    <span class="sd">"""Load movies from u.item into database."""</span>

    <span class="k">print</span> <span class="s2">"Movies"</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s2">"seed_data/u.item"</span><span class="p">)):</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>

        <span class="c1"># clever -- we can unpack part of the row!</span>
        <span class="n">movie_id</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">released_str</span><span class="p">,</span> <span class="n">junk</span><span class="p">,</span> <span class="n">imdb_url</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"|"</span><span class="p">)[:</span><span class="mi">5</span><span class="p">]</span>

        <span class="c1"># The date is in the file as daynum-month_abbreviation-year;</span>
        <span class="c1"># we need to convert it to an actual datetime object.</span>

        <span class="k">if</span> <span class="n">released_str</span><span class="p">:</span>
            <span class="n">released_at</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">released_str</span><span class="p">,</span> <span class="s2">"</span><span class="si">%d</span><span class="s2">-%b-%Y"</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">released_at</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c1"># Remove the (YEAR) from the end of the title.</span>

        <span class="n">title</span> <span class="o">=</span> <span class="n">title</span><span class="p">[:</span><span class="o">-</span><span class="mi">7</span><span class="p">]</span>   <span class="c1"># " (YEAR)" == 7</span>

        <span class="n">movie</span> <span class="o">=</span> <span class="n">Movie</span><span class="p">(</span><span class="n">movie_id</span><span class="o">=</span><span class="n">movie_id</span><span class="p">,</span>
                      <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>
                      <span class="n">released_at</span><span class="o">=</span><span class="n">released_at</span><span class="p">,</span>
                      <span class="n">imdb_url</span><span class="o">=</span><span class="n">imdb_url</span><span class="p">)</span>

        <span class="c1"># We need to add to the session or it won't ever be stored</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">movie</span><span class="p">)</span>

        <span class="c1"># provide some sense of progress</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">i</span>

    <span class="c1"># Once we're done, we should commit our work</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">load_ratings</span><span class="p">():</span>
    <span class="sd">"""Load ratings from u.data into database."""</span>

    <span class="k">print</span> <span class="s2">"Ratings"</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s2">"seed_data/u.data"</span><span class="p">)):</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>

        <span class="n">user_id</span><span class="p">,</span> <span class="n">movie_id</span><span class="p">,</span> <span class="n">score</span><span class="p">,</span> <span class="n">timestamp</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"</span><span class="se">\t</span><span class="s2">"</span><span class="p">)</span>

        <span class="n">user_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">movie_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">movie_id</span><span class="p">)</span>
        <span class="n">score</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>

        <span class="c1"># We don't care about the timestamp, so we'll ignore this</span>

        <span class="n">rating</span> <span class="o">=</span> <span class="n">Rating</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span>
                        <span class="n">movie_id</span><span class="o">=</span><span class="n">movie_id</span><span class="p">,</span>
                        <span class="n">score</span><span class="o">=</span><span class="n">score</span><span class="p">)</span>

        <span class="c1"># We need to add to the session or it won't ever be stored</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">rating</span><span class="p">)</span>

        <span class="c1"># provide some sense of progress</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">1000</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">i</span>

            <span class="c1"># An optimization: if we commit after every add, the database</span>
            <span class="c1"># will do a lot of work committing each record. However, if we</span>
            <span class="c1"># wait until the end, on computers with smaller amounts of</span>
            <span class="c1"># memory, it might thrash around. By committing every 1,000th</span>
            <span class="c1"># add, we'll strike a good balance.</span>

            <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="c1"># Once we're done, we should commit our work</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">set_val_user_id</span><span class="p">():</span>
    <span class="sd">"""Set value for the next user_id after seeding database"""</span>

    <span class="c1"># Get the Max user_id in the database</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">user_id</span><span class="p">))</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>
    <span class="n">max_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1"># Set the value for the next user_id to be max_id + 1</span>
    <span class="n">query</span> <span class="o">=</span> <span class="s2">"SELECT setval('users_user_id_seq', :new_id)"</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">{</span><span class="s1">'new_id'</span><span class="p">:</span> <span class="n">max_id</span> <span class="o">+</span> <span class="mi">1</span><span class="p">})</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="n">connect_to_db</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">create_all</span><span class="p">()</span>

    <span class="n">load_users</span><span class="p">()</span>
    <span class="n">load_movies</span><span class="p">()</span>
    <span class="n">load_ratings</span><span class="p">()</span>
    <span class="n">set_val_user_id</span><span class="p">()</span>

    <span class="c1"># Mimic what we did in the interpreter, and add the Eye and some ratings</span>
    <span class="n">eye</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="s2">"the-eye@of-judgment.com"</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s2">"evil"</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">eye</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="c1"># Toy Story</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">Rating</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">eye</span><span class="o">.</span><span class="n">user_id</span><span class="p">,</span> <span class="n">movie_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">score</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

    <span class="c1"># Robocop 3</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">Rating</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">eye</span><span class="o">.</span><span class="n">user_id</span><span class="p">,</span> <span class="n">movie_id</span><span class="o">=</span><span class="mi">1274</span><span class="p">,</span> <span class="n">score</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

    <span class="c1"># Judge Dredd</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">Rating</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">eye</span><span class="o">.</span><span class="n">user_id</span><span class="p">,</span> <span class="n">movie_id</span><span class="o">=</span><span class="mi">373</span><span class="p">,</span> <span class="n">score</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

    <span class="c1"># 3 Ninjas</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">Rating</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">eye</span><span class="o">.</span><span class="n">user_id</span><span class="p">,</span> <span class="n">movie_id</span><span class="o">=</span><span class="mi">314</span><span class="p">,</span> <span class="n">score</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

    <span class="c1"># Aladdin</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">Rating</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">eye</span><span class="o">.</span><span class="n">user_id</span><span class="p">,</span> <span class="n">movie_id</span><span class="o">=</span><span class="mi">95</span><span class="p">,</span> <span class="n">score</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

    <span class="c1"># The Lion King</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">Rating</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">eye</span><span class="o">.</span><span class="n">user_id</span><span class="p">,</span> <span class="n">movie_id</span><span class="o">=</span><span class="mi">71</span><span class="p">,</span> <span class="n">score</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="c1"># Add our user</span>
    <span class="n">jessica</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="s2">"jessica@gmail.com"</span><span class="p">,</span>
                   <span class="n">password</span><span class="o">=</span><span class="s2">"love"</span><span class="p">,</span>
                   <span class="n">age</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
                   <span class="n">zipcode</span><span class="o">=</span><span class="s2">"94114"</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">jessica</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="c1"># Toy Story</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">Rating</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">jessica</span><span class="o">.</span><span class="n">user_id</span><span class="p">,</span> <span class="n">movie_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">score</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

    <span class="c1"># Robocop 3</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">Rating</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">jessica</span><span class="o">.</span><span class="n">user_id</span><span class="p">,</span> <span class="n">movie_id</span><span class="o">=</span><span class="mi">1274</span><span class="p">,</span> <span class="n">score</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

    <span class="c1"># Judge Dredd</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">Rating</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">jessica</span><span class="o">.</span><span class="n">user_id</span><span class="p">,</span> <span class="n">movie_id</span><span class="o">=</span><span class="mi">373</span><span class="p">,</span> <span class="n">score</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

    <span class="c1"># 3 Ninjas</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">Rating</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">jessica</span><span class="o">.</span><span class="n">user_id</span><span class="p">,</span> <span class="n">movie_id</span><span class="o">=</span><span class="mi">314</span><span class="p">,</span> <span class="n">score</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

    <span class="c1"># Aladdin</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">Rating</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">jessica</span><span class="o">.</span><span class="n">user_id</span><span class="p">,</span> <span class="n">movie_id</span><span class="o">=</span><span class="mi">95</span><span class="p">,</span> <span class="n">score</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

    <span class="c1"># The Lion King</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">Rating</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">jessica</span><span class="o">.</span><span class="n">user_id</span><span class="p">,</span> <span class="n">movie_id</span><span class="o">=</span><span class="mi">71</span><span class="p">,</span> <span class="n">score</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper container" id="id18">
<div class="code-block-caption"><span class="caption-text">step-3/server.py</span></div>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="sd">"""Movie Ratings."""</span>

<span class="kn">from</span> <span class="nn">jinja2</span> <span class="kn">import</span> <span class="n">StrictUndefined</span>

<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">render_template</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">flash</span><span class="p">,</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">session</span>
<span class="kn">from</span> <span class="nn">flask_debugtoolbar</span> <span class="kn">import</span> <span class="n">DebugToolbarExtension</span>

<span class="kn">from</span> <span class="nn">model</span> <span class="kn">import</span> <span class="n">connect_to_db</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">User</span><span class="p">,</span> <span class="n">Movie</span><span class="p">,</span> <span class="n">Rating</span>


<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="c1"># Required to use Flask sessions and the debug toolbar</span>
<span class="n">app</span><span class="o">.</span><span class="n">secret_key</span> <span class="o">=</span> <span class="s2">"ABC"</span>

<span class="c1"># Normally, if you use an undefined variable in Jinja2, it fails silently.</span>
<span class="c1"># This is horrible. Fix this so that, instead, it raises an error.</span>
<span class="n">app</span><span class="o">.</span><span class="n">jinja_env</span><span class="o">.</span><span class="n">undefined</span> <span class="o">=</span> <span class="n">StrictUndefined</span>


<span class="nd">@app.route</span><span class="p">(</span><span class="s1">'/'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="sd">"""Homepage."""</span>

    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s2">"homepage.html"</span><span class="p">)</span>


<span class="nd">@app.route</span><span class="p">(</span><span class="s1">'/register'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">'GET'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">register_form</span><span class="p">():</span>
    <span class="sd">"""Show form for user signup."""</span>

    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s2">"register_form.html"</span><span class="p">)</span>


<span class="nd">@app.route</span><span class="p">(</span><span class="s1">'/register'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">'POST'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">register_process</span><span class="p">():</span>
    <span class="sd">"""Process registration."""</span>

    <span class="c1"># Get form variables</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s2">"email"</span><span class="p">]</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s2">"password"</span><span class="p">]</span>
    <span class="n">age</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s2">"age"</span><span class="p">])</span>
    <span class="n">zipcode</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s2">"zipcode"</span><span class="p">]</span>

    <span class="n">new_user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">,</span> <span class="n">age</span><span class="o">=</span><span class="n">age</span><span class="p">,</span> <span class="n">zipcode</span><span class="o">=</span><span class="n">zipcode</span><span class="p">)</span>

    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">new_user</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="n">flash</span><span class="p">(</span><span class="s2">"User </span><span class="si">%s</span><span class="s2"> added."</span> <span class="o">%</span> <span class="n">email</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">"/"</span><span class="p">)</span>


<span class="nd">@app.route</span><span class="p">(</span><span class="s1">'/login'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">'GET'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">login_form</span><span class="p">():</span>
    <span class="sd">"""Show login form."""</span>

    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s2">"login_form.html"</span><span class="p">)</span>


<span class="nd">@app.route</span><span class="p">(</span><span class="s1">'/login'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">'POST'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">login_process</span><span class="p">():</span>
    <span class="sd">"""Process login."""</span>

    <span class="c1"># Get form variables</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s2">"email"</span><span class="p">]</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s2">"password"</span><span class="p">]</span>

    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
        <span class="n">flash</span><span class="p">(</span><span class="s2">"No such user"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">"/login"</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">password</span> <span class="o">!=</span> <span class="n">password</span><span class="p">:</span>
        <span class="n">flash</span><span class="p">(</span><span class="s2">"Incorrect password"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">"/login"</span><span class="p">)</span>

    <span class="n">session</span><span class="p">[</span><span class="s2">"user_id"</span><span class="p">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">user_id</span>

    <span class="n">flash</span><span class="p">(</span><span class="s2">"Logged in"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">"/users/</span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="n">user</span><span class="o">.</span><span class="n">user_id</span><span class="p">)</span>


<span class="nd">@app.route</span><span class="p">(</span><span class="s1">'/logout'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">logout</span><span class="p">():</span>
    <span class="sd">"""Log out."""</span>

    <span class="k">del</span> <span class="n">session</span><span class="p">[</span><span class="s2">"user_id"</span><span class="p">]</span>
    <span class="n">flash</span><span class="p">(</span><span class="s2">"Logged Out."</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">"/"</span><span class="p">)</span>


<span class="nd">@app.route</span><span class="p">(</span><span class="s2">"/users"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">user_list</span><span class="p">():</span>
    <span class="sd">"""Show list of users."""</span>

    <span class="n">users</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s2">"user_list.html"</span><span class="p">,</span> <span class="n">users</span><span class="o">=</span><span class="n">users</span><span class="p">)</span>


<span class="nd">@app.route</span><span class="p">(</span><span class="s2">"/users/&lt;int:user_id&gt;"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">user_detail</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>
    <span class="sd">"""Show info about user."""</span>

    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s2">"user.html"</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">)</span>


<span class="nd">@app.route</span><span class="p">(</span><span class="s2">"/movies"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">movie_list</span><span class="p">():</span>
    <span class="sd">"""Show list of movies."""</span>

    <span class="n">movies</span> <span class="o">=</span> <span class="n">Movie</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">'title'</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s2">"movie_list.html"</span><span class="p">,</span> <span class="n">movies</span><span class="o">=</span><span class="n">movies</span><span class="p">)</span>


<span class="nd">@app.route</span><span class="p">(</span><span class="s2">"/movies/&lt;int:movie_id&gt;"</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">'GET'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">movie_detail</span><span class="p">(</span><span class="n">movie_id</span><span class="p">):</span>
    <span class="sd">"""Show info about movie.</span>

<span class="sd">    If a user is logged in, let them add/edit a rating.</span>
<span class="sd">    """</span>

    <span class="n">movie</span> <span class="o">=</span> <span class="n">Movie</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">movie_id</span><span class="p">)</span>

    <span class="n">user_id</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"user_id"</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">user_id</span><span class="p">:</span>
        <span class="n">user_rating</span> <span class="o">=</span> <span class="n">Rating</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span>
            <span class="n">movie_id</span><span class="o">=</span><span class="n">movie_id</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">user_rating</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="c1"># Get average rating of movie</span>

    <span class="n">rating_scores</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">score</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">movie</span><span class="o">.</span><span class="n">ratings</span><span class="p">]</span>
    <span class="n">avg_rating</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">rating_scores</span><span class="p">))</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">rating_scores</span><span class="p">)</span>

    <span class="n">prediction</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="c1"># Prediction code: only predict if the user hasn't rated it.</span>

    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">user_rating</span><span class="p">)</span> <span class="ow">and</span> <span class="n">user_id</span><span class="p">:</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">user</span><span class="p">:</span>
            <span class="n">prediction</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">predict_rating</span><span class="p">(</span><span class="n">movie</span><span class="p">)</span>

    <span class="c1"># Either use the prediction or their real rating</span>

    <span class="k">if</span> <span class="n">prediction</span><span class="p">:</span>
        <span class="c1"># User hasn't scored; use our prediction if we made one</span>
        <span class="n">effective_rating</span> <span class="o">=</span> <span class="n">prediction</span>

    <span class="k">elif</span> <span class="n">user_rating</span><span class="p">:</span>
        <span class="c1"># User has already scored for real; use that</span>
        <span class="n">effective_rating</span> <span class="o">=</span> <span class="n">user_rating</span><span class="o">.</span><span class="n">score</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># User hasn't scored, and we couldn't get a prediction</span>
        <span class="n">effective_rating</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="c1"># Get the eye's rating, either by predicting or using real rating</span>

    <span class="n">the_eye</span> <span class="o">=</span> <span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="s2">"the-eye@of-judgment.com"</span><span class="p">)</span>
                         <span class="o">.</span><span class="n">one</span><span class="p">())</span>
    <span class="n">eye_rating</span> <span class="o">=</span> <span class="n">Rating</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span>
        <span class="n">user_id</span><span class="o">=</span><span class="n">the_eye</span><span class="o">.</span><span class="n">user_id</span><span class="p">,</span> <span class="n">movie_id</span><span class="o">=</span><span class="n">movie</span><span class="o">.</span><span class="n">movie_id</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">eye_rating</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">eye_rating</span> <span class="o">=</span> <span class="n">the_eye</span><span class="o">.</span><span class="n">predict_rating</span><span class="p">(</span><span class="n">movie</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">eye_rating</span> <span class="o">=</span> <span class="n">eye_rating</span><span class="o">.</span><span class="n">score</span>

    <span class="k">if</span> <span class="n">eye_rating</span> <span class="ow">and</span> <span class="n">effective_rating</span><span class="p">:</span>
        <span class="n">difference</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">eye_rating</span> <span class="o">-</span> <span class="n">effective_rating</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># We couldn't get an eye rating, so we'll skip difference</span>
        <span class="n">difference</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="c1"># Depending on how different we are from the Eye, choose a</span>
    <span class="c1"># message</span>

    <span class="n">BERATEMENT_MESSAGES</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">"I suppose you don't have such bad taste after all."</span><span class="p">,</span>
        <span class="s2">"I regret every decision that I've ever made that has "</span> <span class="o">+</span>
            <span class="s2">"brought me to listen to your opinion."</span><span class="p">,</span>
        <span class="s2">"Words fail me, as your taste in movies has clearly "</span> <span class="o">+</span>
            <span class="s2">"failed you."</span><span class="p">,</span>
        <span class="s2">"That movie is great. For a clown to watch. Idiot."</span><span class="p">,</span>
        <span class="s2">"Words cannot express the awfulness of your taste."</span>
    <span class="p">]</span>

    <span class="k">if</span> <span class="n">difference</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">beratement</span> <span class="o">=</span> <span class="n">BERATEMENT_MESSAGES</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">difference</span><span class="p">)]</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">beratement</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
        <span class="s2">"movie.html"</span><span class="p">,</span>
        <span class="n">movie</span><span class="o">=</span><span class="n">movie</span><span class="p">,</span>
        <span class="n">user_rating</span><span class="o">=</span><span class="n">user_rating</span><span class="p">,</span>
        <span class="n">average</span><span class="o">=</span><span class="n">avg_rating</span><span class="p">,</span>
        <span class="n">prediction</span><span class="o">=</span><span class="n">prediction</span><span class="p">,</span>
        <span class="n">eye_rating</span><span class="o">=</span><span class="n">eye_rating</span><span class="p">,</span>
        <span class="n">difference</span><span class="o">=</span><span class="n">difference</span><span class="p">,</span>
        <span class="n">beratement</span><span class="o">=</span><span class="n">beratement</span>
        <span class="p">)</span>


<span class="nd">@app.route</span><span class="p">(</span><span class="s2">"/movies/&lt;int:movie_id&gt;"</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">'POST'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">movie_detail_process</span><span class="p">(</span><span class="n">movie_id</span><span class="p">):</span>
    <span class="sd">"""Add/edit a rating."""</span>

    <span class="c1"># Get form variables</span>
    <span class="n">score</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s2">"score"</span><span class="p">])</span>

    <span class="n">user_id</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"user_id"</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">user_id</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">"No user logged in."</span><span class="p">)</span>

    <span class="n">rating</span> <span class="o">=</span> <span class="n">Rating</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span> <span class="n">movie_id</span><span class="o">=</span><span class="n">movie_id</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">rating</span><span class="p">:</span>
        <span class="n">rating</span><span class="o">.</span><span class="n">score</span> <span class="o">=</span> <span class="n">score</span>
        <span class="n">flash</span><span class="p">(</span><span class="s2">"Rating updated."</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">rating</span> <span class="o">=</span> <span class="n">Rating</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span> <span class="n">movie_id</span><span class="o">=</span><span class="n">movie_id</span><span class="p">,</span> <span class="n">score</span><span class="o">=</span><span class="n">score</span><span class="p">)</span>
        <span class="n">flash</span><span class="p">(</span><span class="s2">"Rating added."</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">rating</span><span class="p">)</span>

    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">"/movies/</span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="n">movie_id</span><span class="p">)</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="c1"># We have to set debug=True here, since it has to be True at the point</span>
    <span class="c1"># that we invoke the DebugToolbarExtension</span>
    <span class="n">app</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="n">connect_to_db</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>

    <span class="c1"># Use the DebugToolbar</span>
    <span class="n">DebugToolbarExtension</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>

    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper container" id="id19">
<div class="code-block-caption"><span class="caption-text">step-3/correlation.py</span></div>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="sd">"""Pearson correlation."""</span>

<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">sqrt</span>


<span class="k">def</span> <span class="nf">pearson</span><span class="p">(</span><span class="n">pairs</span><span class="p">):</span>
    <span class="sd">"""Return Pearson correlation for pairs.</span>

<span class="sd">    Using a set of pairwise ratings, produces a Pearson similarity rating.</span>
<span class="sd">    """</span>

    <span class="n">series_1</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">]</span>
    <span class="n">series_2</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">]</span>

    <span class="n">sum_1</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">series_1</span><span class="p">)</span>
    <span class="n">sum_2</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">series_2</span><span class="p">)</span>

    <span class="n">squares_1</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">n</span> <span class="o">*</span> <span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">series_1</span><span class="p">])</span>
    <span class="n">squares_2</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">n</span> <span class="o">*</span> <span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">series_2</span><span class="p">])</span>

    <span class="n">product_sum</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">n</span> <span class="o">*</span> <span class="n">m</span> <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">])</span>

    <span class="n">size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pairs</span><span class="p">)</span>

    <span class="n">numerator</span> <span class="o">=</span> <span class="n">product_sum</span> <span class="o">-</span> <span class="p">((</span><span class="n">sum_1</span> <span class="o">*</span> <span class="n">sum_2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">)</span>

    <span class="n">denominator</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span>
        <span class="p">(</span><span class="n">squares_1</span> <span class="o">-</span> <span class="p">(</span><span class="n">sum_1</span> <span class="o">*</span> <span class="n">sum_1</span><span class="p">)</span> <span class="o">/</span> <span class="n">size</span><span class="p">)</span> <span class="o">*</span>
        <span class="p">(</span><span class="n">squares_2</span> <span class="o">-</span> <span class="p">(</span><span class="n">sum_2</span> <span class="o">*</span> <span class="n">sum_2</span><span class="p">)</span> <span class="o">/</span> <span class="n">size</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">denominator</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>

    <span class="k">return</span> <span class="n">numerator</span> <span class="o">/</span> <span class="n">denominator</span>
</pre></div>
</div>
</div>
<div class="section" id="id1">
<h3>Templates</h3>
<div class="literal-block-wrapper container" id="id20">
<div class="code-block-caption"><span class="caption-text">step-3/templates/base.html</span></div>
<div class="highlight-jinja"><div class="highlight"><pre><span></span><span class="x">&lt;!doctype html&gt;</span>
<span class="x">&lt;html&gt;</span>
<span class="x">&lt;head&gt;</span>
<span class="x">    &lt;title&gt;Ratings&lt;/title&gt;</span>
<span class="x">&lt;/head&gt;</span>
<span class="x">&lt;body&gt;</span>

<span class="x">Ratings</span>

<span class="cp">{%</span> <span class="k">if</span> <span class="s2">"user_id"</span> <span class="k">in</span> <span class="nv">session</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">    &lt;a href="/logout"&gt;Logout&lt;/a&gt;</span>
<span class="cp">{%</span> <span class="k">else</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">    &lt;a href="/login"&gt;Login&lt;/a&gt;</span>
<span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span><span class="x"></span>

<span class="x">&lt;hr&gt;</span>

<span class="cp">{%</span> <span class="k">for</span> <span class="nv">flash</span> <span class="k">in</span> <span class="nv">get_flashed_messages</span><span class="o">()</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">  </span><span class="cp">{{</span> <span class="nv">flash</span> <span class="cp">}}</span><span class="x"></span>
<span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span><span class="x"></span>

<span class="cp">{%</span> <span class="k">block</span> <span class="nv">content</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">    Put your body here.</span>
<span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span><span class="x"></span>

<span class="x">&lt;/body&gt;</span>
<span class="x">&lt;/html&gt;</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper container" id="id21">
<div class="code-block-caption"><span class="caption-text">step-3/templates/homepage.html</span></div>
<div class="highlight-jinja"><div class="highlight"><pre><span></span><span class="cp">{%</span> <span class="k">extends</span> <span class="s1">'base.html'</span> <span class="cp">%}</span><span class="x"></span>
<span class="cp">{%</span> <span class="k">block</span> <span class="nv">content</span> <span class="cp">%}</span><span class="x"></span>

<span class="x">  &lt;h1&gt;Ratings&lt;/h1&gt;</span>

<span class="x">  &lt;h2&gt;Movies&lt;/h2&gt;</span>
<span class="x">  &lt;p&gt;&lt;a href="/movies"&gt;View all movies&lt;/a&gt;&lt;/p&gt;</span>

<span class="x">  &lt;h2&gt;Users&lt;/h2&gt;</span>
<span class="x">  &lt;p&gt;&lt;a href="/users"&gt;View all users&lt;/a&gt;&lt;/p&gt;</span>

<span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span><span class="x"></span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper container" id="id22">
<div class="code-block-caption"><span class="caption-text">step-3/templates/login_form.html</span></div>
<div class="highlight-jinja"><div class="highlight"><pre><span></span><span class="cp">{%</span> <span class="k">extends</span> <span class="s1">'base.html'</span> <span class="cp">%}</span><span class="x"></span>
<span class="cp">{%</span> <span class="k">block</span> <span class="nv">content</span> <span class="cp">%}</span><span class="x"></span>

<span class="x">    &lt;h1&gt;Login&lt;/h1&gt;</span>
<span class="x">    &lt;form action="/login" method="POST"&gt;</span>

<span class="x">        &lt;div&gt;</span>
<span class="x">            &lt;label&gt;Email:</span>
<span class="x">                &lt;input type="email" name="email" required&gt;</span>
<span class="x">            &lt;/label&gt;</span>
<span class="x">        &lt;/div&gt;</span>

<span class="x">        &lt;div&gt;</span>
<span class="x">            &lt;label&gt;Password:</span>
<span class="x">                &lt;input type="password" name="password" required&gt;</span>
<span class="x">            &lt;/label&gt;</span>
<span class="x">        &lt;/div&gt;</span>

<span class="x">        &lt;div&gt;</span>
<span class="x">            &lt;input type="submit" value="Log In"&gt;</span>
<span class="x">        &lt;/div&gt;</span>

<span class="x">    &lt;/form&gt;</span>
<span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span><span class="x"></span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper container" id="id23">
<div class="code-block-caption"><span class="caption-text">step-3/templates/movie.html</span></div>
<div class="highlight-jinja"><div class="highlight"><pre><span></span><span class="cp">{%</span> <span class="k">extends</span> <span class="s1">'base.html'</span> <span class="cp">%}</span><span class="x"></span>
<span class="cp">{%</span> <span class="k">block</span> <span class="nv">content</span> <span class="cp">%}</span><span class="x"></span>

<span class="x">    &lt;h1&gt;</span><span class="cp">{{</span> <span class="nv">movie.title</span> <span class="cp">}}</span><span class="x">&lt;/h1&gt;</span>
<span class="x">    &lt;p&gt;Released: </span><span class="cp">{{</span> <span class="nv">movie.released_at</span> <span class="cp">}}</span><span class="x">&lt;/p&gt;</span>
<span class="x">    &lt;p&gt;IMDB: &lt;a href="</span><span class="cp">{{</span> <span class="nv">movie.imdb_url</span> <span class="cp">}}</span><span class="x">"&gt;</span><span class="cp">{{</span> <span class="nv">movie.imdb_url</span> <span class="cp">}}</span><span class="x">&lt;/a&gt;&lt;/p&gt;</span>

<span class="x">    &lt;p&gt;Average rating: </span><span class="cp">{{</span> <span class="nv">average</span> <span class="cp">}}</span><span class="x">&lt;/p&gt;</span>
<span class="x">  </span><span class="cp">{%</span> <span class="k">if</span> <span class="nv">prediction</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">      &lt;p&gt;We predict you will rate this movie </span><span class="cp">{{</span> <span class="nv">prediction</span> <span class="cp">}}</span><span class="x">.&lt;/p&gt;</span>
<span class="x">  </span><span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span><span class="x"></span>

<span class="x">  </span><span class="cp">{%</span> <span class="k">if</span> <span class="nv">eye_rating</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">      &lt;h2&gt;The Judgmental Eye&lt;/h2&gt;</span>
<span class="x">      &lt;p&gt;Eye Rating: &lt;b&gt;</span><span class="cp">{{</span> <span class="nv">eye_rating</span> <span class="cp">}}</span><span class="x">&lt;/b&gt;&lt;/p&gt;</span>
<span class="x">    </span><span class="cp">{%</span> <span class="k">if</span> <span class="nv">difference</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">        &lt;p&gt;Difference: &lt;b&gt;</span><span class="cp">{{</span> <span class="nv">difference</span> <span class="cp">}}</span><span class="x">&lt;/b&gt;&lt;/p&gt;</span>
<span class="x">    </span><span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">    </span><span class="cp">{%</span> <span class="k">if</span> <span class="nv">beratement</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">        &lt;p&gt;The Eye says: &lt;b&gt;</span><span class="cp">{{</span> <span class="nv">beratement</span> <span class="cp">}}</span><span class="x">&lt;/b&gt;&lt;/p&gt;</span>
<span class="x">    </span><span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">  </span><span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span><span class="x"></span>

<span class="x">  </span><span class="cp">{%</span> <span class="k">if</span> <span class="s2">"user_id"</span> <span class="k">in</span> <span class="nv">session</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">      &lt;h2&gt;Your Rating&lt;/h2&gt;</span>
<span class="x">    </span><span class="cp">{%</span> <span class="k">if</span> <span class="nv">user_rating</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">        &lt;p&gt;You currently rate this a </span><span class="cp">{{</span> <span class="nv">user_rating.score</span> <span class="cp">}}</span><span class="x">&lt;/p&gt;</span>
<span class="x">    </span><span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">      &lt;form action="/movies/</span><span class="cp">{{</span> <span class="nv">movie.movie_id</span> <span class="cp">}}</span><span class="x">" method="POST"&gt;</span>
<span class="x">          &lt;label&gt;Rating:</span>
<span class="x">              &lt;input type="number" name="score"&gt;</span>
<span class="x">          &lt;/label&gt;</span>
<span class="x">          &lt;input type="submit" value="Rate"&gt;</span>
<span class="x">      &lt;/form&gt;</span>
<span class="x">  </span><span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span><span class="x"></span>

<span class="x">  </span><span class="cp">{%</span> <span class="k">if</span> <span class="nv">movie.ratings</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">      &lt;h2&gt;Ratings&lt;/h2&gt;</span>
<span class="x">      &lt;ul&gt;</span>
<span class="x">        </span><span class="cp">{%</span> <span class="k">for</span> <span class="nv">rating</span> <span class="k">in</span> <span class="nv">movie.ratings</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">            &lt;li&gt;</span>
<span class="x">                &lt;a href="/users/</span><span class="cp">{{</span> <span class="nv">rating.user_id</span> <span class="cp">}}</span><span class="x">"&gt;</span><span class="cp">{{</span> <span class="nv">rating.user_id</span> <span class="cp">}}</span><span class="x">&lt;/a&gt;</span>
<span class="x">                rated </span><span class="cp">{{</span> <span class="nv">rating.score</span> <span class="cp">}}</span><span class="x">&lt;/li&gt;</span>
<span class="x">        </span><span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">      &lt;/ul&gt;</span>
<span class="x">  </span><span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span><span class="x"></span>



<span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span><span class="x"></span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper container" id="id24">
<div class="code-block-caption"><span class="caption-text">step-3/templates/movie_list.html</span></div>
<div class="highlight-jinja"><div class="highlight"><pre><span></span><span class="cp">{%</span> <span class="k">extends</span> <span class="s1">'base.html'</span> <span class="cp">%}</span><span class="x"></span>
<span class="cp">{%</span> <span class="k">block</span> <span class="nv">content</span> <span class="cp">%}</span><span class="x"></span>

<span class="x">  &lt;h1&gt;Movies&lt;/h1&gt;</span>
<span class="x">  &lt;ul&gt;</span>
<span class="x">  </span><span class="cp">{%</span> <span class="k">for</span> <span class="nv">movie</span> <span class="k">in</span> <span class="nv">movies</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">    &lt;li&gt;</span>
<span class="x">      &lt;a href="/movies/</span><span class="cp">{{</span> <span class="nv">movie.movie_id</span> <span class="cp">}}</span><span class="x">"&gt;</span><span class="cp">{{</span> <span class="nv">movie.title</span> <span class="cp">}}</span><span class="x">&lt;/a&gt;</span>
<span class="x">    &lt;/li&gt;</span>
<span class="x">  </span><span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">  &lt;/ul&gt;</span>
<span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span><span class="x"></span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper container" id="id25">
<div class="code-block-caption"><span class="caption-text">step-3/templates/register_form.html</span></div>
<div class="highlight-jinja"><div class="highlight"><pre><span></span><span class="cp">{%</span> <span class="k">extends</span> <span class="s1">'base.html'</span> <span class="cp">%}</span><span class="x"></span>
<span class="cp">{%</span> <span class="k">block</span> <span class="nv">content</span> <span class="cp">%}</span><span class="x"></span>

<span class="x">&lt;h1&gt;Register&lt;/h1&gt;</span>

<span class="x">&lt;form action="register" method="POST"&gt;</span>

<span class="x">    &lt;div&gt;</span>
<span class="x">        &lt;label&gt;</span>
<span class="x">            Email</span>
<span class="x">            &lt;input type="email" name="email"&gt;</span>
<span class="x">        &lt;/label&gt;</span>
<span class="x">    &lt;/div&gt;</span>

<span class="x">    &lt;div&gt;</span>
<span class="x">        &lt;label&gt;</span>
<span class="x">            Password</span>
<span class="x">            &lt;input type="password" name="password"&gt;</span>
<span class="x">        &lt;/label&gt;</span>
<span class="x">    &lt;/div&gt;</span>

<span class="x">    &lt;div&gt;</span>
<span class="x">        &lt;label&gt;</span>
<span class="x">            Age</span>
<span class="x">            &lt;input type="number" name="age"&gt;</span>
<span class="x">        &lt;/label&gt;</span>
<span class="x">    &lt;/div&gt;</span>

<span class="x">    &lt;div&gt;</span>
<span class="x">        &lt;label&gt;</span>
<span class="x">            Zipcode</span>
<span class="x">            &lt;input type="text" name="zipcode"&gt;</span>
<span class="x">        &lt;/label&gt;</span>
<span class="x">    &lt;/div&gt;</span>

<span class="x">    &lt;div&gt;</span>
<span class="x">        &lt;input type="submit" value="Register"&gt;</span>
<span class="x">    &lt;/div&gt;</span>

<span class="x">&lt;/form&gt;</span>

<span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span><span class="x"></span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper container" id="id26">
<div class="code-block-caption"><span class="caption-text">step-3/templates/user.html</span></div>
<div class="highlight-jinja"><div class="highlight"><pre><span></span><span class="cp">{%</span> <span class="k">extends</span> <span class="s1">'base.html'</span> <span class="cp">%}</span><span class="x"></span>
<span class="cp">{%</span> <span class="k">block</span> <span class="nv">content</span> <span class="cp">%}</span><span class="x"></span>

<span class="x">  &lt;h1&gt;</span><span class="cp">{{</span> <span class="nv">user.email</span> <span class="cp">}}</span><span class="x"> (</span><span class="cp">{{</span> <span class="nv">user.user_id</span> <span class="cp">}}</span><span class="x">)&lt;/h1&gt;</span>

<span class="x">  &lt;p&gt;Age: </span><span class="cp">{{</span> <span class="nv">user.age</span> <span class="cp">}}</span><span class="x">&lt;/p&gt;</span>
<span class="x">  &lt;p&gt;Zipcode: </span><span class="cp">{{</span> <span class="nv">user.zipcode</span> <span class="cp">}}</span><span class="x">&lt;/p&gt;</span>

<span class="x">  </span><span class="cp">{%</span> <span class="k">if</span> <span class="nv">user.ratings</span> <span class="cp">%}</span><span class="x"></span>

<span class="x">    &lt;h2&gt;Ratings&lt;/h2&gt;</span>
<span class="x">    &lt;ul&gt;</span>
<span class="x">    </span><span class="cp">{%</span> <span class="k">for</span> <span class="nv">rating</span> <span class="k">in</span> <span class="nv">user.ratings</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">      &lt;li&gt;</span>
<span class="x">        &lt;a href="/movies/</span><span class="cp">{{</span> <span class="nv">rating.movie_id</span> <span class="cp">}}</span><span class="x">"&gt;</span><span class="cp">{{</span> <span class="nv">rating.movie.title</span> <span class="cp">}}</span><span class="x">&lt;/a&gt;</span>
<span class="x">        was rated </span><span class="cp">{{</span> <span class="nv">rating.score</span> <span class="cp">}}</span><span class="x"></span>
<span class="x">      &lt;/li&gt;</span>
<span class="x">    </span><span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">    &lt;/ul&gt;</span>
<span class="x">  </span><span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span><span class="x"></span>

<span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span><span class="x"></span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper container" id="id27">
<div class="code-block-caption"><span class="caption-text">step-3/templates/user_list.html</span></div>
<div class="highlight-jinja"><div class="highlight"><pre><span></span><span class="cp">{%</span> <span class="k">extends</span> <span class="s1">'base.html'</span> <span class="cp">%}</span><span class="x"></span>
<span class="cp">{%</span> <span class="k">block</span> <span class="nv">content</span> <span class="cp">%}</span><span class="x"></span>

<span class="x">    &lt;h2&gt;Users&lt;/h2&gt;</span>
<span class="x">    &lt;ul&gt;</span>
<span class="x">      </span><span class="cp">{%</span> <span class="k">for</span> <span class="nv">user</span> <span class="k">in</span> <span class="nv">users</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">          &lt;li&gt;</span>
<span class="x">              &lt;a href="/users/</span><span class="cp">{{</span> <span class="nv">user.user_id</span> <span class="cp">}}</span><span class="x">"&gt;</span>
<span class="x">                </span><span class="cp">{{</span> <span class="nv">user.email</span> <span class="cp">}}</span><span class="x"> (</span><span class="cp">{{</span> <span class="nv">user.user_id</span> <span class="cp">}}</span><span class="x">)</span>
<span class="x">              &lt;/a&gt;</span>
<span class="x">          &lt;/li&gt;</span>
<span class="x">      </span><span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">    &lt;/ul&gt;</span>

<span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span><span class="x"></span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="bootstrap">
<h2>Bootstrap</h2>
<p>If youâd like to see a Bootstrap-enabled version of the application,
you can see our âstep-4â in the solutions folder.</p>
<div class="section" id="id2">
<h3>Templates</h3>
<div class="literal-block-wrapper container" id="id28">
<div class="code-block-caption"><span class="caption-text">step-4/templates/base.html</span></div>
<div class="highlight-jinja"><div class="highlight"><pre><span></span><span class="x">&lt;!DOCTYPE html&gt;</span>
<span class="x">&lt;html lang="en"&gt;</span>
<span class="x">&lt;head&gt;</span>
<span class="x">    &lt;meta charset="utf-8"&gt;</span>
<span class="x">    &lt;meta http-equiv="X-UA-Compatible" content="IE=edge"&gt;</span>
<span class="x">    &lt;meta name="viewport" content="width=device-width, initial-scale=1"&gt;</span>

<span class="x">    &lt;title&gt;The Judgmental Eye&lt;/title&gt;</span>

<span class="x">    &lt;!-- Bootstrap --&gt;</span>
<span class="x">    &lt;link href="//maxcdn.bootstrapcdn.com/bootswatch/3.3.4/cyborg/bootstrap.min.css"</span>
<span class="x">          rel="stylesheet"&gt;</span>
<span class="x">&lt;link href='http://fonts.googleapis.com/css?family=Frijole' rel='stylesheet' type='text/css'&gt;</span>
<span class="x">    &lt;style&gt;</span>
<span class="x">        h1, h2, h3, .navbar-brand { font-family: "Frijole"; }</span>

<span class="x">        </span>
<span class="x">        #homepage-title {</span>
<span class="x">            margin: 0;</span>
<span class="x">            top: 0.5em;</span>
<span class="x">            width: 100%;</span>
<span class="x">            text-align: center;</span>
<span class="x">            color: black;</span>
<span class="x">            font-weight: 400;</span>
<span class="x">            font-size: 500%;</span>
<span class="x">        }</span>

<span class="x">        html, body {</span>
<span class="x">          width: 100%;</span>
<span class="x">          height: 100%;</span>
<span class="x">          margin: 0;</span>
<span class="x">          background-color: #B22222;</span>
<span class="x">        }</span>

<span class="x">        #homepage-block {</span>
<span class="x">          width: 100%;</span>
<span class="x">          height: 100%;</span>
<span class="x">          margin: 0;</span>
<span class="x">          padding: 0;</span>
<span class="x">          background-image: url("/static/sauron.jpg");</span>
<span class="x">          background-size: 100%;</span>
<span class="x">        }</span>

<span class="x">        #extending {</span>
<span class="x">                      margin: 0px;</span>
<span class="x">                      padding: 0px;</span>
<span class="x">                      background-color: #B22222;</span>
<span class="x">                      width: 100%;</span>
<span class="x">                      height: 100%;</span>
<span class="x">                   }</span>

<span class="x">        .spaced {</span>
<span class="x">          margin-left:20px; </span>
<span class="x">          margin-top: 20px;</span>
<span class="x">        }</span>

<span class="x">    &lt;/style&gt;</span>
<span class="x">&lt;/head&gt;</span>
<span class="x">&lt;body&gt;</span>
<span class="x">&lt;nav class="navbar navbar-inverse" style="margin-bottom: 0px"&gt;</span>
<span class="x">    &lt;div class="container-fluid"&gt;</span>
<span class="x">        &lt;!-- Brand and toggle get grouped for better mobile display --&gt;</span>
<span class="x">        &lt;div class="navbar-header"&gt;</span>
<span class="x">            &lt;button type="button" class="navbar-toggle collapsed"</span>
<span class="x">                    data-toggle="collapse"</span>
<span class="x">                    data-target="#bs-example-navbar-collapse-1"&gt;</span>
<span class="x">                &lt;span class="sr-only"&gt;Toggle navigation&lt;/span&gt;</span>
<span class="x">                &lt;span class="icon-bar"&gt;&lt;/span&gt;</span>
<span class="x">                &lt;span class="icon-bar"&gt;&lt;/span&gt;</span>
<span class="x">                &lt;span class="icon-bar"&gt;&lt;/span&gt;</span>
<span class="x">            &lt;/button&gt;</span>
<span class="x">            &lt;a class="navbar-brand" href="/"&gt;</span>
<span class="x">                &lt;span class="glyphicon glyphicon-eye-open"&gt;&lt;/span&gt;</span>
<span class="x">                The Judgmental Eye</span>
<span class="x">            &lt;/a&gt;</span>
<span class="x">        &lt;/div&gt;</span>

<span class="x">        &lt;!-- Collect the nav links, forms, and other content for toggling --&gt;</span>
<span class="x">        &lt;div class="collapse navbar-collapse"</span>
<span class="x">             id="bs-example-navbar-collapse-1"&gt;</span>
<span class="x">            &lt;ul class="nav navbar-nav"&gt;</span>
<span class="x">                &lt;li&gt;&lt;a href="/users"&gt;View All Users&lt;/a&gt;&lt;/li&gt;</span>
<span class="x">                &lt;li&gt;&lt;a href="/movies"&gt;View All Movies&lt;/a&gt;&lt;/li&gt;</span>
<span class="x">            &lt;/ul&gt;</span>
<span class="x">            &lt;ul class="nav navbar-nav navbar-right"&gt;</span>
<span class="x">              </span><span class="cp">{%</span> <span class="k">if</span> <span class="s2">"user_id"</span> <span class="k">in</span> <span class="nv">session</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">                  &lt;li&gt;&lt;a href="/users/</span><span class="cp">{{</span> <span class="nv">session</span><span class="o">[</span><span class="s1">'user_id'</span><span class="o">]</span> <span class="cp">}}</span><span class="x">"&gt;Profile&lt;/a&gt;&lt;/li&gt;</span>
<span class="x">                  &lt;li&gt;&lt;a href="/logout"&gt;Logout&lt;/a&gt;&lt;/li&gt;</span>
<span class="x">              </span><span class="cp">{%</span> <span class="k">else</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">                  &lt;li&gt;&lt;a href="/register"&gt;Register&lt;/a&gt;&lt;/li&gt;</span>
<span class="x">                  &lt;li&gt;&lt;a href="/login"&gt;Login&lt;/a&gt;&lt;/li&gt;</span>
<span class="x">              </span><span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span><span class="x"></span>

<span class="x">            &lt;/ul&gt;</span>
<span class="x">        &lt;/div&gt;</span>
<span class="x">        &lt;!-- /.navbar-collapse --&gt;</span>
<span class="x">    &lt;/div&gt;</span>
<span class="x">    &lt;!-- /.container-fluid --&gt;</span>
<span class="x">&lt;/nav&gt;</span>
<span class="x">&lt;div id="extending"&gt;</span>
<span class="x">    </span><span class="cp">{%</span> <span class="k">for</span> <span class="nv">flash</span> <span class="k">in</span> <span class="nv">get_flashed_messages</span><span class="o">()</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">      &lt;div class="alert alert-danger" style="width:90%; margin:0 auto;"&gt;</span><span class="cp">{{</span> <span class="nv">flash</span> <span class="cp">}}</span><span class="x">&lt;/div&gt;</span>
<span class="x">    </span><span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span><span class="x"></span>
<span class="cp">{%</span> <span class="k">block</span> <span class="nv">content</span> <span class="cp">%}</span><span class="x"></span>
<span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">&lt;/div&gt;</span>

<span class="x">&lt;script src="https://code.jquery.com/jquery-2.1.4.min.js"&gt;&lt;/script&gt;</span>
<span class="x">&lt;script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"&gt;&lt;/script&gt;</span>

<span class="x">&lt;/body&gt;</span>
<span class="x">&lt;/html&gt;</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper container" id="id29">
<div class="code-block-caption"><span class="caption-text">step-4/templates/homepage.html</span></div>
<div class="highlight-jinja"><div class="highlight"><pre><span></span><span class="cp">{%</span> <span class="k">extends</span> <span class="s1">'base.html'</span> <span class="cp">%}</span><span class="x"></span>
<span class="cp">{%</span> <span class="k">block</span> <span class="nv">content</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">	&lt;div id="homepage-block"&gt;</span>
<span class="x">    	&lt;h1 id="homepage-title"&gt;The Judgmental Eye&lt;/h1&gt;</span>
<span class="x">	&lt;/div&gt;</span>

<span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span><span class="x"></span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper container" id="id30">
<div class="code-block-caption"><span class="caption-text">step-4/templates/login_form.html</span></div>
<div class="highlight-jinja"><div class="highlight"><pre><span></span><span class="cp">{%</span> <span class="k">extends</span> <span class="s1">'base.html'</span> <span class="cp">%}</span><span class="x"></span>
<span class="cp">{%</span> <span class="k">block</span> <span class="nv">content</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">&lt;div class="well spaced" style="width:40%;"&gt;</span>
<span class="x">&lt;div&gt;</span>
<span class="x">    &lt;h1&gt;Login&lt;/h1&gt;</span>
<span class="x">    &lt;form action="/login" method="POST"&gt;</span>

<span class="x">        &lt;div class="form-group"&gt;</span>
<span class="x">            &lt;label&gt;Email:</span>
<span class="x">                &lt;input type="email" name="email" required class="form-control"&gt;</span>
<span class="x">            &lt;/label&gt;</span>
<span class="x">        &lt;/div&gt;</span>

<span class="x">        &lt;div class="form-group"&gt;</span>
<span class="x">            &lt;label&gt;Password:</span>
<span class="x">                &lt;input type="password" name="password" required class="form-control"&gt;</span>
<span class="x">            &lt;/label&gt;</span>
<span class="x">        &lt;/div&gt;</span>

<span class="x">        &lt;div class="form-group"&gt;</span>
<span class="x">            &lt;input type="submit" value="Log In If You Dare" class="btn btn-danger"&gt;</span>
<span class="x">        &lt;/div&gt;</span>

<span class="x">    &lt;/form&gt;</span>
<span class="x">&lt;/div&gt;</span>
<span class="x">&lt;/div&gt;</span>
<span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span><span class="x"></span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper container" id="id31">
<div class="code-block-caption"><span class="caption-text">step-4/templates/movie.html</span></div>
<div class="highlight-jinja"><div class="highlight"><pre><span></span><span class="cp">{%</span> <span class="k">extends</span> <span class="s1">'base.html'</span> <span class="cp">%}</span><span class="x"></span>
<span class="cp">{%</span> <span class="k">block</span> <span class="nv">content</span> <span class="cp">%}</span><span class="x"></span>

<span class="x">&lt;div class="well spaced" style="width:97%;"&gt;</span>
<span class="x">&lt;h1&gt;</span><span class="cp">{{</span> <span class="nv">movie.title</span> <span class="cp">}}</span><span class="x">&lt;/h1&gt;</span>

<span class="x">&lt;div class="row"&gt;</span>

<span class="x">    &lt;div class="col-xs-12 col-lg-6"&gt;</span>
<span class="x">        &lt;p&gt;Released: </span><span class="cp">{{</span> <span class="nv">movie.released_at</span> <span class="cp">}}</span><span class="x">&lt;/p&gt;</span>

<span class="x">        &lt;p&gt;IMDB: &lt;a href="</span><span class="cp">{{</span> <span class="nv">movie.imdb_url</span> <span class="cp">}}</span><span class="x">"&gt;</span><span class="cp">{{</span> <span class="nv">movie.imdb_url</span> <span class="cp">}}</span><span class="x">&lt;/a&gt;</span>
<span class="x">        &lt;/p&gt;</span>

<span class="x">        &lt;p&gt;Average rating: </span><span class="cp">{{</span> <span class="nv">average</span> <span class="cp">}}</span><span class="x">&lt;/p&gt;</span>
<span class="x">      </span><span class="cp">{%</span> <span class="k">if</span> <span class="nv">prediction</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">          &lt;p&gt;We predict you will rate this movie </span><span class="cp">{{</span> <span class="nv">prediction</span> <span class="cp">}}</span><span class="x">.&lt;/p&gt;</span>
<span class="x">      </span><span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span><span class="x"></span>


<span class="x">      </span><span class="cp">{%</span> <span class="k">if</span> <span class="nv">movie.ratings</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">          &lt;h2&gt;Ratings&lt;/h2&gt;</span>
<span class="x">          &lt;ul&gt;</span>
<span class="x">            </span><span class="cp">{%</span> <span class="k">for</span> <span class="nv">rating</span> <span class="k">in</span> <span class="nv">movie.ratings</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">                &lt;li&gt;</span>
<span class="x">                    &lt;a href="/users/</span><span class="cp">{{</span> <span class="nv">rating.user_id</span> <span class="cp">}}</span><span class="x">"&gt;</span><span class="cp">{{</span> <span class="nv">rating.user_id</span> <span class="cp">}}</span><span class="x">&lt;/a&gt;</span>
<span class="x">                    rated </span><span class="cp">{{</span> <span class="nv">rating.score</span> <span class="cp">}}</span><span class="x">&lt;/li&gt;</span>
<span class="x">            </span><span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">          &lt;/ul&gt;</span>
<span class="x">      </span><span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">    &lt;/div&gt;</span>


<span class="x">    &lt;div class="col-xs-12 col-lg-6"&gt;</span>
<span class="x">      </span><span class="cp">{%</span> <span class="k">if</span> <span class="nv">eye_rating</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">          &lt;h2&gt;The Judgmental Eye&lt;/h2&gt;</span>
<span class="x">          &lt;p&gt;Eye Rating: &lt;b class="text-danger"&gt;</span><span class="cp">{{</span> <span class="nv">eye_rating</span> <span class="cp">}}</span><span class="x">&lt;/b&gt;&lt;/p&gt;</span>
<span class="x">        </span><span class="cp">{%</span> <span class="k">if</span> <span class="nv">difference</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">            &lt;p&gt;Difference: &lt;b class="text-danger"&gt;</span><span class="cp">{{</span> <span class="nv">difference</span> <span class="cp">}}</span><span class="x">&lt;/b&gt;&lt;/p&gt;</span>
<span class="x">        </span><span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">        </span><span class="cp">{%</span> <span class="k">if</span> <span class="nv">beratement</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">          &lt;p&gt;The Eye says: &lt;b class="text-danger"&gt;</span><span class="cp">{{</span> <span class="nv">beratement</span> <span class="cp">}}</span><span class="x">&lt;/b&gt;&lt;/p&gt;</span>
<span class="x">        </span><span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">      </span><span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">      </span><span class="cp">{%</span> <span class="k">if</span> <span class="s2">"user_id"</span> <span class="k">in</span> <span class="nv">session</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">          &lt;h2&gt;Your Rating&lt;/h2&gt;</span>
<span class="x">        </span><span class="cp">{%</span> <span class="k">if</span> <span class="nv">user_rating</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">            &lt;p&gt;You currently rate this a </span><span class="cp">{{</span> <span class="nv">user_rating.score</span> <span class="cp">}}</span><span class="x">&lt;/p&gt;</span>
<span class="x">        </span><span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">          &lt;form action="/movies/</span><span class="cp">{{</span> <span class="nv">movie.movie_id</span> <span class="cp">}}</span><span class="x">" method="POST"&gt;</span>
<span class="x">              &lt;div class="form-group"&gt;</span>
<span class="x">                  &lt;label&gt;Rating:</span>
<span class="x">                      &lt;input type="number" name="score"</span>
<span class="x">                             class="form-control input-sm"&gt;</span>
<span class="x">                  &lt;/label&gt;</span>
<span class="x">              &lt;/div&gt;</span>
<span class="x">              &lt;input type="submit" value="Record Your Puny Rating"</span>
<span class="x">                     class="btn btn-danger"&gt;</span>
<span class="x">          &lt;/form&gt;</span>
<span class="x">      </span><span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span><span class="x"></span>

<span class="x">    &lt;/div&gt;</span>
<span class="x">&lt;/div&gt;</span>
<span class="x">&lt;/div&gt;</span>
<span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span><span class="x"></span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper container" id="id32">
<div class="code-block-caption"><span class="caption-text">step-4/templates/movie_list.html</span></div>
<div class="highlight-jinja"><div class="highlight"><pre><span></span><span class="cp">{%</span> <span class="k">extends</span> <span class="s1">'base.html'</span> <span class="cp">%}</span><span class="x"></span>
<span class="cp">{%</span> <span class="k">block</span> <span class="nv">content</span> <span class="cp">%}</span><span class="x"></span>

<span class="x">&lt;div class="well spaced" style="width:50%;"&gt;</span>
<span class="x">  &lt;h2&gt;Movies&lt;/h2&gt;</span>
<span class="x">  &lt;ul&gt;</span>
<span class="x">  </span><span class="cp">{%</span> <span class="k">for</span> <span class="nv">movie</span> <span class="k">in</span> <span class="nv">movies</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">    &lt;li&gt;</span>
<span class="x">      &lt;a href="/movies/</span><span class="cp">{{</span> <span class="nv">movie.movie_id</span> <span class="cp">}}</span><span class="x">"&gt;</span><span class="cp">{{</span> <span class="nv">movie.title</span> <span class="cp">}}</span><span class="x">&lt;/a&gt;</span>
<span class="x">    &lt;/li&gt;</span>
<span class="x">  </span><span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">  &lt;/ul&gt;</span>
<span class="x">&lt;/div&gt;</span>
<span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span><span class="x"></span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper container" id="id33">
<div class="code-block-caption"><span class="caption-text">step-4/templates/register_form.html</span></div>
<div class="highlight-jinja"><div class="highlight"><pre><span></span><span class="cp">{%</span> <span class="k">extends</span> <span class="s1">'base.html'</span> <span class="cp">%}</span><span class="x"></span>
<span class="cp">{%</span> <span class="k">block</span> <span class="nv">content</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">&lt;div class="well spaced" style="width:40%;"&gt;</span>
<span class="x">&lt;h1&gt;Register&lt;/h1&gt;</span>

<span class="x">&lt;form action="register" method="POST"&gt;</span>

<span class="x">    &lt;div class="form-group"&gt;</span>
<span class="x">        &lt;label&gt;</span>
<span class="x">            Email</span>
<span class="x">            &lt;input type="email" name="email" class="form-control"&gt;</span>
<span class="x">        &lt;/label&gt;</span>
<span class="x">    &lt;/div&gt;</span>

<span class="x">    &lt;div class="form-group"&gt;</span>
<span class="x">        &lt;label&gt;</span>
<span class="x">            Password</span>
<span class="x">            &lt;input type="password" name="password" class="form-control"&gt;</span>
<span class="x">        &lt;/label&gt;</span>
<span class="x">    &lt;/div&gt;</span>

<span class="x">    &lt;div class="form-group"&gt;</span>
<span class="x">        &lt;label&gt;</span>
<span class="x">            Age</span>
<span class="x">            &lt;input type="number" name="age" class="form-control"&gt;</span>
<span class="x">        &lt;/label&gt;</span>
<span class="x">    &lt;/div&gt;</span>

<span class="x">    &lt;div class="form-group"&gt;</span>
<span class="x">        &lt;label&gt;</span>
<span class="x">            Zipcode</span>
<span class="x">            &lt;input type="text" name="zipcode" class="form-control"&gt;</span>
<span class="x">        &lt;/label&gt;</span>
<span class="x">    &lt;/div&gt;</span>

<span class="x">    &lt;div class="form-group"&gt;</span>
<span class="x">        &lt;input type="submit" value="Register, Mortal" class="btn btn-danger"&gt;</span>
<span class="x">    &lt;/div&gt;</span>

<span class="x">&lt;/form&gt;</span>
<span class="x">&lt;/div&gt;</span>
<span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span><span class="x"></span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper container" id="id34">
<div class="code-block-caption"><span class="caption-text">step-4/templates/user.html</span></div>
<div class="highlight-jinja"><div class="highlight"><pre><span></span><span class="cp">{%</span> <span class="k">extends</span> <span class="s1">'base.html'</span> <span class="cp">%}</span><span class="x"></span>
<span class="cp">{%</span> <span class="k">block</span> <span class="nv">content</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">&lt;br&gt;</span>
<span class="x">&lt;div class="well spaced" style="width:97%"&gt;</span>
<span class="x">  &lt;h2&gt;</span><span class="cp">{{</span> <span class="nv">user.email</span> <span class="cp">}}</span><span class="x"> (</span><span class="cp">{{</span> <span class="nv">user.user_id</span> <span class="cp">}}</span><span class="x">)&lt;/h2&gt;</span>

<span class="x">  &lt;b&gt;&lt;p style="color:red"&gt;Age: </span><span class="cp">{{</span> <span class="nv">user.age</span> <span class="cp">}}</span><span class="x">&lt;/p&gt;</span>
<span class="x">  &lt;p style="color:red"&gt;Zipcode: </span><span class="cp">{{</span> <span class="nv">user.zipcode</span> <span class="cp">}}</span><span class="x">&lt;/p&gt;&lt;/b&gt;</span>

<span class="x">  </span><span class="cp">{%</span> <span class="k">if</span> <span class="nv">user.ratings</span> <span class="cp">%}</span><span class="x"></span>

<span class="x">    &lt;h3&gt;Ratings&lt;/h3&gt;</span>
<span class="x">    &lt;ul&gt;</span>
<span class="x">    </span><span class="cp">{%</span> <span class="k">for</span> <span class="nv">rating</span> <span class="k">in</span> <span class="nv">user.ratings</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">      &lt;li&gt;</span>
<span class="x">        &lt;a href="/movies/</span><span class="cp">{{</span> <span class="nv">rating.movie_id</span> <span class="cp">}}</span><span class="x">"&gt;</span><span class="cp">{{</span> <span class="nv">rating.movie.title</span> <span class="cp">}}</span><span class="x">&lt;/a&gt;</span>
<span class="x">        was rated </span><span class="cp">{{</span> <span class="nv">rating.score</span> <span class="cp">}}</span><span class="x"></span>
<span class="x">      &lt;/li&gt;</span>
<span class="x">    </span><span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">    &lt;/ul&gt;</span>
<span class="x">  </span><span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">&lt;/div&gt;</span>
<span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span><span class="x"></span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper container" id="id35">
<div class="code-block-caption"><span class="caption-text">step-4/templates/user_list.html</span></div>
<div class="highlight-jinja"><div class="highlight"><pre><span></span><span class="cp">{%</span> <span class="k">extends</span> <span class="s1">'base.html'</span> <span class="cp">%}</span><span class="x"></span>
<span class="cp">{%</span> <span class="k">block</span> <span class="nv">content</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">&lt;div class="well spaced" style="width:60%"&gt;</span>
<span class="x">    &lt;h2&gt;Users&lt;/h2&gt;</span>
<span class="x">    &lt;ul&gt;</span>
<span class="x">      </span><span class="cp">{%</span> <span class="k">for</span> <span class="nv">user</span> <span class="k">in</span> <span class="nv">users</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">          &lt;li&gt;</span>
<span class="x">              &lt;a href="/users/</span><span class="cp">{{</span> <span class="nv">user.user_id</span> <span class="cp">}}</span><span class="x">"&gt;</span>
<span class="x">                </span><span class="cp">{{</span> <span class="nv">user.user_id</span> <span class="cp">}}</span><span class="x"> (</span><span class="cp">{{</span> <span class="nv">user.email</span> <span class="cp">}}</span><span class="x">)</span>
<span class="x">              &lt;/a&gt;</span>
<span class="x">          &lt;/li&gt;</span>
<span class="x">      </span><span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">    &lt;/ul&gt;</span>
<span class="x">&lt;/div&gt;</span>
<span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span><span class="x"></span>
</pre></div>
</div>
</div>
</div>
</div>
</div>



    </div>
</div>
<script type="text/javascript" src="./Solution_files/jquery.js"></script>
<script type="text/javascript" src="./Solution_files/underscore.js"></script>
<script type="text/javascript" src="./Solution_files/doctools.js"></script> 

</body></html>